<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fio Certo</title>
<style>
:root{
  --bg:#f3f6fb; --card:#ffffff; --muted:#6b7280; --accent:#0ea5a3; --accent-darker:#0b8f8c;
  --btn:#0369a1; --success:#10b981; --danger:#ef4444; --radius:12px; --glass: rgba(255,255,255,0.7);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#e6eef7,var(--bg));color:#0f172a;}
.container{max-width:980px;margin:28px auto;padding:20px;}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;}
.title{display:flex;gap:12px;align-items:center;}
.logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-darker));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;}
h1{font-size:20px;margin:0} .subtitle{color:var(--muted);font-size:13px;}
.grid{display:grid;grid-template-columns: 1fr 420px;gap:18px;}
.card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow: 0 6px 20px rgba(15,23,42,0.06);}
label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
select,input{width:100%;padding:10px 12px;margin-top:6px;border-radius:10px;border:1px solid #e6eef7;background:var(--glass);font-size:14px;}
.row{display:flex;gap:10px;align-items:center;margin-top:12px}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;}
.btn-primary{background:var(--btn);color:white;box-shadow:0 8px 18px rgba(3,105,161,0.12)}
.btn-primary:hover{background:#054b73}
.btn-sec{background:#fff;border:1px solid #e6eef7}
.btn-green{background:var(--success);color:white}
.btn-danger{background:var(--danger);color:white}
.small{font-size:13px;color:var(--muted);}
.resultTitle{font-weight:700;margin:0 0 6px 0}
.resultBox{background:#07122a;color:#e6fffb;padding:14px;border-radius:10px;white-space:pre-wrap;font-family:monospace}

/* MODAL & OVERLAY */
#overlay{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:60}
#modal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:500px;max-width:94%;z-index:70;border-radius:12px;padding:18px;background:var(--card);box-shadow:0 20px 60px rgba(2,6,23,0.25);max-height:90vh;overflow:auto}
.modalHeader{display:flex;justify-content:space-between;align-items:center; margin-bottom: 10px;}
.modalClose{background:transparent;border:none;color:var(--muted);font-weight:700;cursor:pointer}
.note{font-size:13px;color:var(--muted);margin-top:6px}

/* INSTALA√á√ïES NO MODAL */
.install-list { margin-top: 15px; border-top: 1px solid #e6eef7; padding-top: 10px; }
.install-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.install-item strong { display: block; font-size: 14px; color: #334155; }
.install-item span { font-size: 12px; color: #64748b; }
.section-title { font-size: 14px; font-weight: 700; color: var(--accent-darker); margin-top: 20px; border-bottom: 2px solid #e6eef7; padding-bottom: 5px; margin-bottom: 10px; }

/* TOAST NOTIFICATIONS */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; display: flex; align-items: center; animation: slideIn 0.3s ease; min-width: 250px;}
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.info { background: var(--btn); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* AUTOCOMPLETE SUGGESTIONS */
.suggestions-box { position: absolute; background: white; width: 100%; border: 1px solid #e2e8f0; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 50; margin-top: 2px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
.suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
.suggestion-item:hover { background: #f1f5f9; }
.relative { position: relative; }

/* OR SEPARATOR STYLE */
.separator-box { margin: 15px 0; border-bottom: 1px solid #e6eef7; position: relative; text-align: center; }
.separator-text { background: white; padding: 0 10px; color: #999; font-size: 12px; position: relative; top: 8px; }

@media (max-width:900px){.grid{grid-template-columns:1fr; }.title h1{font-size:18px}}
</style>
</head>
<body>

<div id="toast-container" class="toast-container"></div>

<div class="container">

  <div class="header">
    <div class="title">
      <div class="logo">FC</div>
      <div>
        <h1>Fio Certo</h1>
        <div class="subtitle">Padr√µes de cores e locais para instala√ß√£o (Online)</div>
      </div>
    </div>
    <div>
      <button class="btn btn-primary" onclick="abrirCadastro()">Cadastrar</button>
      <button class="btn btn-sec" onclick="abrirEditar()">Editar Ve√≠culos</button>
    </div>
  </div>

  <div class="grid" id="gridPrincipal">
    <div class="card">
        
      <label style="color:var(--accent-darker); font-weight:700">üîç Busca R√°pida</label>
      <div class="relative">
          <input id="mainSearchInput" placeholder="Digite ex: Uno Way 2020..." autocomplete="off">
          <div id="mainSuggestions" class="suggestions-box"></div>
      </div>

      <div class="separator-box">
          <span class="separator-text">OU FILTRE ABAIXO</span>
      </div>

      <label>Tipo do ve√≠culo</label>
      <select id="tipoSelect">
        <option value="">-- selecione --</option>
        <option value="carro">Carro</option>
        <option value="moto">Moto</option>
        <option value="caminhao">Caminh√£o</option>
      </select>

      <div id="marcaWrap" style="display:none">
        <label>Marca</label>
        <select id="marcaSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="modeloWrap" style="display:none">
        <label>Modelo</label>
        <select id="modeloSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="subWrap" style="display:none">
        <label>Submodelo</label>
        <select id="submodeloSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="anoWrap" style="display:none">
        <label>Ano</label>
        <select id="anoSelect"><option value="">-- selecione --</option></select>
      </div>

      <div class="row" style="margin-top:16px">
        <button class="btn btn-primary" onclick="buscar()">Buscar</button>
        <button class="btn btn-sec" onclick="resetBusca()">Limpar</button>
      </div>
    </div>

    <div class="card">
      <h3 class="resultTitle">Resultado</h3>
      
      <div id="seletorLocalWrap" style="display:none; margin-bottom: 15px; padding: 10px; background: #eff6ff; border-radius: 8px;">
        <label style="color: #1e3a8a; font-weight: bold; margin-top:0;">Op√ß√£o de Local de Instala√ß√£o:</label>
        <select id="resultadoLocalSelect" style="background: white; border: 1px solid #bfdbfe; color: #1e3a8a; font-weight: 600;">
        </select>
      </div>

      <div id="resultado" class="resultBox" style="font-family:Verdana;font-size:20px;">Carregando sistema...</div>
      
      <div id="btnEditarResultado" style="margin-top:10px;text-align:right;display:none">
         </div>
    </div>
  </div>

  <div id="editarAba" style="display:none;">
    <div class="card">
      <div class="row" style="justify-content:flex-end;margin-bottom:8px;">
        <button class="btn btn-sec" onclick="voltarBusca()">Voltar √† Busca</button>
      </div>
      
      <h3>Gerenciar Ve√≠culos</h3>

      <label style="color:var(--accent-darker); font-weight:700">üîç Busca R√°pida (Lista)</label>
      <input id="editSearchInput" placeholder="Digite ex: Honda Civic 2020..." onkeyup="filtrarEdicao()">

      <div class="separator-box">
          <span class="separator-text">OU FILTRE ABAIXO</span>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px">
          <div>
            <label>Tipo</label>
            <select id="editTipo" style="margin-top:0"><option value="">-- todos --</option><option value="carro">Carro</option><option value="moto">Moto</option><option value="caminhao">Caminh√£o</option></select>
          </div>
          <div>
              <label>Marca</label>
              <select id="editMarca" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div>
              <label>Modelo</label>
              <select id="editModelo" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div>
              <label>Submodelo</label>
              <select id="editSub" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div>
              <label>Ano</label>
              <select id="editAno" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
      </div>

      <div id="listaVeiculos" style="margin-top:12px;"></div>
    </div>
  </div>

</div>

<div id="overlay"></div>
<div id="modal">
  <div class="modalHeader">
    <strong id="modalTitle">Cadastrar ve√≠culo</strong>
    <button class="modalClose" onclick="fecharModal()">X</button>
  </div>
  <p class="note">Preencha os dados do ve√≠culo e adicione as op√ß√µes de instala√ß√£o.</p>

  <div class="section-title">1. Dados do Ve√≠culo</div>
  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
      <div><label>Tipo</label><select id="addTipo"><option value="carro">Carro</option><option value="moto">Moto</option><option value="caminhao">Caminh√£o</option></select></div>
      <div><label>Marca</label><select id="addMarca"></select></div>
  </div>
  <label>Modelo</label><input id="addModelo">
  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
    <div><label>Submodelo</label><input id="addSubmodelo"></div>
    <div><label>Ano</label><input id="addAno" type="number"></div>
  </div>

  <div class="section-title">2. Adicionar Op√ß√£o de Instala√ß√£o</div>
  <div style="background: #f1f5f9; padding: 12px; border-radius: 8px;">
      <label style="color:#0f172a; font-weight:700">Nome do Local (Ex: Caixa de Fus√≠veis)</label>
      <input id="addNomeLocal" placeholder="Ex: Painel, Caixa de Fus√≠veis, Airbag...">
      
      <label>Local Detalhado (Opcional)</label>
      <input id="addLocalDetalhe" placeholder="Ex: Abaixo do volante, fio grosso">

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
        <div><label>Positivo</label><input id="addPositivo"></div>
        <div><label>Negativo</label><input id="addNegativo"></div>
      </div>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
        <div><label>P√≥s-chave</label><input id="addPosChave"></div>
        <div><label>Bloqueio</label><input id="addBloqueio"></div>
      </div>

      <button class="btn btn-sec" style="width:100%; margin-top:10px; border-color:var(--accent); color:var(--accent-darker)" onclick="adicionarInstalacaoNaLista()">+ Adicionar esta Op√ß√£o</button>
  </div>

  <div class="section-title">Op√ß√µes Adicionadas (<span id="countInstalacoes">0</span>)</div>
  <div id="listaInstalacoesAdd" class="install-list">
      <div style="text-align:center; color:var(--muted); font-size:13px;">Nenhuma op√ß√£o adicionada ainda.</div>
  </div>

  <div class="row" style="justify-content:flex-end;margin-top:14px; border-top: 2px solid #ddd; padding-top:10px;">
    <button class="btn btn-sec" onclick="fecharModal()">Cancelar</button>
    <button class="btn btn-green" id="btnSalvar">Salvar Ve√≠culo Completo</button>
  </div>
</div>

<script type="module">
  /* ================= FIREBASE SETUP ================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB097Hr3Vg55djiCjW8A3m_vhK4Jen-Xlw",
    authDomain: "fiocertorastreador.firebaseapp.com",
    projectId: "fiocertorastreador",
    storageBucket: "fiocertorastreador.firebasestorage.app",
    messagingSenderId: "735489114974",
    appId: "1:735489114974:web:40820bcec28e2b252fc5cf",
    measurementId: "G-2P8HSDLBLZ"
  };

  const app = initializeApp(firebaseConfig);
  const dbFirestore = getFirestore(app);
  const veiculosCollection = collection(dbFirestore, "veiculos");

  /* ================= VARI√ÅVEIS GLOBAIS ================= */
  let userDB = []; 
  let db = [];
  let editarIndex = null;
  let tempInstalacoes = [];
  let currentVehicleResult = null;

  const marcas = {
    carro:["Fiat","Volkswagen","Chevrolet","Toyota","Ford","Renault","Peugeot","Citro√´n","Honda","Hyundai","Land Rover","Ram","BYD"],
    moto:["Honda","Yamaha","Suzuki","BMW","Shineray","Dafra","Kawasaki"],
    caminhao:["Volvo","Scania","Mercedes-Benz","Volkswagen Caminh√µes","Iveco","Ford","Renault Trucks","Hyundai HR / Kia Bongo"]
  };

  const $ = id => document.getElementById(id);

  /* ================= NOTIFICATION SYSTEM (TOAST) ================= */
  window.showNotification = function(message, type = 'info') {
      const container = $("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      
      let icon = '';
      if(type === 'success') icon = '‚úÖ ';
      if(type === 'error') icon = '‚ùå ';
      if(type === 'info') icon = '‚ÑπÔ∏è ';

      toast.innerHTML = `<span>${icon} ${message}</span>`;
      container.appendChild(toast);

      setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          toast.style.transition = 'all 0.3s ease';
          setTimeout(() => toast.remove(), 300);
      }, 3500);
  };

  /* ================= CARREGAMENTO INICIAL ================= */
  async function carregarDadosDoFirebase() {
    $("resultado").innerText = "Carregando banco de dados...";
    try {
      const querySnapshot = await getDocs(veiculosCollection);
      userDB = [];
      querySnapshot.forEach((doc) => {
        userDB.push({ id: doc.id, ...doc.data() });
      });
      db = [...userDB]; 
      $("resultado").innerText = "Sistema pronto. Fa√ßa sua busca.";
      if($("editarAba").style.display === "block") {
          popularFiltros();
          renderLista();
      }
    } catch (e) {
      console.error("Erro ao ler dados: ", e);
      $("resultado").innerText = "Erro ao conectar com servidor.";
      showNotification("Erro de conex√£o com o servidor", "error");
    }
  }
  carregarDadosDoFirebase();

  /* ================= UI FUNCTIONS ================= */

  window.abrirCadastro = function() {
    editarIndex = null;
    tempInstalacoes = [];
    $("modalTitle").innerText = "Cadastrar ve√≠culo";
    $("addTipo").value = "carro";
    preencherAddMarca();
    
    ["addMarca","addModelo","addSubmodelo","addAno"].forEach(id => $(id).value = "");
    limparCamposInstalacao();
    renderTempInstalacoes();

    $("overlay").style.display = "block";
    $("modal").style.display = "block";
  };

  window.fecharModal = function() {
    $("overlay").style.display = "none";
    $("modal").style.display = "none";
    editarIndex = null;
    tempInstalacoes = [];
  };

  window.abrirEditar = function() {
    $("editarAba").style.display = "block";
    $("gridPrincipal").style.display = "none";
    popularFiltros();
    renderLista();
  };

  window.voltarBusca = function() {
    $("editarAba").style.display = "none";
    $("gridPrincipal").style.display = "grid";
  };

  function limparCamposInstalacao() {
    ["addNomeLocal", "addLocalDetalhe", "addPositivo", "addNegativo", "addPosChave", "addBloqueio"].forEach(id => $(id).value = "");
  }

  /* ================= L√ìGICA DE INSTALA√á√ïES (MODAL) ================= */
  
  window.adicionarInstalacaoNaLista = function() {
    const nome = $("addNomeLocal").value.trim();
    if(!nome) { showNotification("D√™ um nome para o local (ex: Painel).", "error"); return; }
    
    const novaInstalacao = {
      nomeLocal: nome,
      localDetalhe: $("addLocalDetalhe").value.trim(),
      positivo: $("addPositivo").value.trim(),
      negativo: $("addNegativo").value.trim(),
      posChave: $("addPosChave").value.trim(),
      bloqueio: $("addBloqueio").value.trim()
    };

    tempInstalacoes.push(novaInstalacao);
    renderTempInstalacoes();
    limparCamposInstalacao();
    showNotification("Op√ß√£o de instala√ß√£o adicionada!", "success");
  };

  window.removerInstalacaoTemp = function(index) {
    tempInstalacoes.splice(index, 1);
    renderTempInstalacoes();
  };

  // NOVA FUN√á√ÉO DE EDI√á√ÉO INDIVIDUAL DA INSTALA√á√ÉO
  window.editarInstalacaoTemp = function(index) {
      const item = tempInstalacoes[index];
      
      // Joga os valores de volta para os inputs
      $("addNomeLocal").value = item.nomeLocal;
      $("addLocalDetalhe").value = item.localDetalhe;
      $("addPositivo").value = item.positivo;
      $("addNegativo").value = item.negativo;
      $("addPosChave").value = item.posChave;
      $("addBloqueio").value = item.bloqueio;

      // Remove da lista para o usu√°rio "Adicionar" novamente corrigido
      tempInstalacoes.splice(index, 1);
      renderTempInstalacoes();
      
      showNotification("Dados carregados. Edite e clique em '+ Adicionar' novamente.", "info");
      $("addNomeLocal").focus();
  };

  function renderTempInstalacoes() {
    const container = $("listaInstalacoesAdd");
    $("countInstalacoes").innerText = tempInstalacoes.length;
    
    if(tempInstalacoes.length === 0) {
      container.innerHTML = "<div style='text-align:center; color:var(--muted); font-size:13px;'>Nenhuma op√ß√£o adicionada ainda.</div>";
      return;
    }

    container.innerHTML = "";
    tempInstalacoes.forEach((inst, index) => {
      let div = document.createElement("div");
      div.className = "install-item";
      div.innerHTML = `
        <div>
          <strong>${inst.nomeLocal}</strong>
          <span>${inst.localDetalhe || "Sem detalhes"}</span>
        </div>
        <div style="display:flex; gap:6px;">
            <button class="btn btn-sec" style="padding:4px 10px; font-size:12px;" onclick="editarInstalacaoTemp(${index})">Editar</button>
            <button class="btn btn-danger" style="padding:4px 10px; font-size:12px;" onclick="removerInstalacaoTemp(${index})">Remover</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  /* ================= BUSCA R√ÅPIDA (FUZZY SEARCH - PRINCIPAL) ================= */
  const mainInput = $("mainSearchInput");
  const suggestionsBox = $("mainSuggestions");

  mainInput.addEventListener("input", function() {
      const val = this.value.toLowerCase().trim();
      if(val.length < 2) { suggestionsBox.style.display = "none"; return; }

      const terms = val.split(" ");
      const matches = db.filter(v => {
          const str = `${v.tipo} ${v.marca} ${v.modelo} ${v.submodelo} ${v.ano}`.toLowerCase();
          return terms.every(t => str.includes(t));
      }).slice(0, 8); // Top 8 results

      if(matches.length === 0) {
           suggestionsBox.style.display = "none";
           return;
      }

      suggestionsBox.innerHTML = "";
      matches.forEach(v => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.innerHTML = `<strong>${v.modelo}</strong> <small>${v.marca} (${v.ano})</small>`;
          div.onclick = () => {
              mainInput.value = `${v.marca} ${v.modelo} ${v.ano}`;
              suggestionsBox.style.display = "none";
              exibirResultadoDireto(v);
          };
          suggestionsBox.appendChild(div);
      });
      suggestionsBox.style.display = "block";
  });

  document.addEventListener("click", (e) => {
      if(e.target !== mainInput) suggestionsBox.style.display = "none";
  });

  /* ================= BUSCA INTELIGENTE COM SELETOR ================= */

  window.buscar = function() {
    let {tipoSelect,marcaSelect,modeloSelect,submodeloSelect,anoSelect} = ids();
    
    let r = db.find(v => v.tipo === tipoSelect.value && v.marca === marcaSelect.value && v.modelo === modeloSelect.value
      && (v.submodelo||"") === submodeloSelect.value && v.ano === anoSelect.value);
    
    if(!r) { $("resultado").innerText = "Nenhum padr√£o encontrado."; return; }
    exibirResultadoDireto(r);
  };

  function exibirResultadoDireto(r) {
      currentVehicleResult = r;
      $("seletorLocalWrap").style.display = "none";
      $("btnEditarResultado").style.display = "none";

      let instalacoes = r.instalacoes || [];
      
      if(instalacoes.length === 0 && r.local) {
          instalacoes.push({
            nomeLocal: "Padr√£o (√önico)",
            localDetalhe: r.local,
            positivo: r.positivo,
            negativo: r.negativo,
            posChave: r.posChave,
            bloqueio: r.bloqueio
          });
      }

      if(instalacoes.length === 0) {
          $("resultado").innerText = "Ve√≠culo cadastrado, mas sem dados de fia√ß√£o.";
      } else {
          const select = $("resultadoLocalSelect");
          select.innerHTML = "";
          instalacoes.forEach((inst, idx) => {
              let opt = document.createElement("option");
              opt.value = idx;
              opt.text = inst.nomeLocal + (inst.localDetalhe ? ` - ${inst.localDetalhe}` : "");
              select.appendChild(opt);
          });

          $("seletorLocalWrap").style.display = "block";
          renderizarDetalhesInstalacao(instalacoes[0]);

          select.onchange = () => {
              renderizarDetalhesInstalacao(instalacoes[select.value]);
          };
      }

      const btnDiv = $("btnEditarResultado");
      btnDiv.style.display = "block";
      btnDiv.innerHTML = `<button class='btn btn-sec' onclick="editarVeiculo('${r.id}')">Editar este Ve√≠culo</button>`;
  }

  function renderizarDetalhesInstalacao(dados) {
      $("resultado").innerHTML = 
      `<div style="font-family:Verdana;font-size:20px; color:white;">Local de instala√ß√£o: ${dados.localDetalhe || dados.nomeLocal}</div>
       <div style="font-family:Verdana;font-size:20px; color:white;">Positivo: ${dados.positivo}</div>
       <div style="font-family:Verdana;font-size:20px; color:white;">Negativo: ${dados.negativo}</div>
       <div style="font-family:Verdana;font-size:20px; color:white;">P√≥s-chave: ${dados.posChave}</div>
       <div style="font-family:Verdana;font-size:20px; color:white;">Bloqueio: ${dados.bloqueio}</div>`;
  }

  window.resetBusca = function() {
    ["tipoSelect","marcaSelect","modeloSelect","submodeloSelect","anoSelect"].forEach(id => $(id).value = "");
    ["marcaWrap","modeloWrap","subWrap","anoWrap"].forEach(id => $(id).style.display = "none");
    $("seletorLocalWrap").style.display = "none";
    $("btnEditarResultado").style.display = "none";
    $("mainSearchInput").value = "";
    $("resultado").innerText = "Sistema pronto. Fa√ßa sua busca.";
  };

  /* ================= SALVAR, EXCLUIR E EDITAR ================= */

  window.editarVeiculo = function(id) {
    const v = userDB.find(x => x.id === id);
    if(!v) { showNotification('Ve√≠culo n√£o encontrado.','error'); return; }
    
    editarIndex = id;
    $("modalTitle").innerText = "Editar ve√≠culo";
    
    $("addTipo").value = v.tipo;
    preencherAddMarca();
    $("addMarca").value = v.marca;
    $("addModelo").value = v.modelo;
    $("addSubmodelo").value = v.submodelo;
    $("addAno").value = v.ano;

    tempInstalacoes = v.instalacoes || [];
    
    if(tempInstalacoes.length === 0 && v.local) {
         tempInstalacoes.push({
            nomeLocal: "Instala√ß√£o Padr√£o",
            localDetalhe: v.local,
            positivo: v.positivo,
            negativo: v.negativo,
            posChave: v.posChave,
            bloqueio: v.bloqueio
        });
    }

    renderTempInstalacoes();
    limparCamposInstalacao();

    $("overlay").style.display = "block";
    $("modal").style.display = "block";
  };

  window.removerVeiculo = async function(id) {
      if(confirm("Tem certeza que deseja EXCLUIR este ve√≠culo permanentemente?")) {
          try {
              await deleteDoc(doc(dbFirestore, "veiculos", id));
              showNotification("Ve√≠culo exclu√≠do com sucesso.", "success");
              await carregarDadosDoFirebase();
          } catch(e) {
              console.error(e);
              showNotification("Erro ao excluir ve√≠culo.", "error");
          }
      }
  };

  $("btnSalvar").onclick = async () => {
    $("btnSalvar").innerText = "Salvando...";
    $("btnSalvar").disabled = true;

    if(tempInstalacoes.length === 0) {
        showNotification("Adicione pelo menos uma op√ß√£o de instala√ß√£o.", "error");
        $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
        $("btnSalvar").disabled = false;
        return;
    }

    const v = {
      tipo: $("addTipo").value,
      marca: $("addMarca").value,
      modelo: $("addModelo").value.trim(),
      submodelo: $("addSubmodelo").value.trim(),
      ano: $("addAno").value.trim(),
      instalacoes: tempInstalacoes
    };

    if(!v.tipo || !v.marca || !v.modelo || !v.ano) {
      showNotification("Preencha Marca, Modelo e Ano.", "error");
      $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
      $("btnSalvar").disabled = false;
      return;
    }

    try {
      if (editarIndex) {
        await updateDoc(doc(dbFirestore, "veiculos", editarIndex), v);
        showNotification("Ve√≠culo atualizado!", "success");
      } else {
        await addDoc(veiculosCollection, v);
        showNotification("Ve√≠culo cadastrado!", "success");
      }
      await carregarDadosDoFirebase();
      fecharModal();
    } catch (e) {
      console.error("Erro ao salvar: ", e);
      showNotification("Erro ao salvar no servidor.", "error");
    } finally {
      $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
      $("btnSalvar").disabled = false;
    }
  };

  /* ================= FILTROS LISTA DE EDI√á√ÉO ================= */

  window.filtrarEdicao = function() {
    const termo = $("editSearchInput").value.toLowerCase().trim();
    
    let lista = userDB.filter(v => {
      // Filtro de texto (Fuzzy simples)
      const fullString = `${v.marca} ${v.modelo} ${v.submodelo} ${v.ano}`.toLowerCase();
      const matchTexto = !termo || termo.split(" ").every(t => fullString.includes(t));

      // Filtros de select
      const matchTipo = !$("editTipo").value || v.tipo === $("editTipo").value;
      const matchMarca = !$("editMarca").value || v.marca === $("editMarca").value;
      const matchModelo = !$("editModelo").value || v.modelo === $("editModelo").value;
      const matchSub = !$("editSub").value || v.submodelo === $("editSub").value;
      const matchAno = !$("editAno").value || v.ano === $("editAno").value;

      return matchTexto && matchTipo && matchMarca && matchModelo && matchSub && matchAno;
    });

    renderLista(lista);
  };

  function preencherAddMarca(){
    const t = $("addTipo").value;
    $("addMarca").innerHTML = "";
    marcas[t].forEach(m => {
      let o = document.createElement("option");
      o.value = m; o.text = m;
      $("addMarca").appendChild(o);
    });
  }
  $("addTipo").addEventListener("change", preencherAddMarca);

  function addOpt(id,v){
    let o = document.createElement("option");
    o.value = v; o.text = v;
    $(id).appendChild(o);
  }
  
  function clearOptions(id, placeholder){
    const el = $(id); if(!el) return; el.innerHTML = "";
    let o = document.createElement('option'); o.value = ''; o.text = placeholder || '-- selecione --';
    el.appendChild(o);
  }

  function resetCascata(ids){
    ids.forEach(n => { const el = $(n+"Select"); if(el) el.innerHTML = "<option value=''>-- selecione --</option>"; });
  }

  function ids(){
    return {
      tipoSelect: $("tipoSelect"), marcaSelect: $("marcaSelect"),
      modeloSelect: $("modeloSelect"), submodeloSelect: $("submodeloSelect"), anoSelect: $("anoSelect")
    };
  }

  /* ================= CASCATA BUSCA ANTIGA ================= */
  $("tipoSelect").addEventListener("change",()=>{
    resetCascata(["marca","modelo","submodelo","ano"]);
    if($("tipoSelect").value){
      $("marcaWrap").style.display="block";
      $("marcaSelect").innerHTML = "<option value=''>-- selecione --</option>";
      marcas[$("tipoSelect").value].forEach(m=>addOpt("marcaSelect",m));
    }
  });

  $("marcaSelect").addEventListener("change",()=>{
    resetCascata(["modelo","submodelo","ano"]);
    let {tipoSelect,marcaSelect}=ids();
    let modelos=[...new Set(db.filter(v=>v.tipo===tipoSelect.value&&v.marca===marcaSelect.value).map(v=>v.modelo))];
    if(modelos.length){
      $("modeloWrap").style.display="block";
      $("modeloSelect").innerHTML = "<option value=''>-- selecione --</option>";
      modelos.forEach(v=>addOpt("modeloSelect",v));
    }
  });

  $("modeloSelect").addEventListener("change",()=>{
    resetCascata(["submodelo","ano"]);
    let {tipoSelect,marcaSelect,modeloSelect}=ids();
    let subs=[...new Set(db.filter(v=>v.tipo===tipoSelect.value&&v.marca===marcaSelect.value&&v.modelo===modeloSelect.value).map(v=>v.submodelo).filter(s=>s))];
    $("subWrap").style.display="block";
    $("submodeloSelect").innerHTML = "<option value=''>-- selecione --</option>";
    if(subs.length){subs.forEach(v=>addOpt("submodeloSelect",v));}
    else popularAnos(tipoSelect.value,marcaSelect.value,modeloSelect.value,"");
  });

  $("submodeloSelect").addEventListener("change",()=>{
    popularAnos($("tipoSelect").value,$("marcaSelect").value,$("modeloSelect").value,$("submodeloSelect").value);
  });

  function popularAnos(t,m,mo,s){
    resetCascata(["ano"]);
    $("anoWrap").style.display="block";
    [...new Set(db.filter(v=>v.tipo===t&&v.marca===m&&v.modelo===mo&&(s?v.submodelo===s:true)).map(v=>v.ano))]
    .sort().forEach(a=>addOpt("anoSelect",a));
  }

  /* ================= LISTAGEM E RENDERIZA√á√ÉO ================= */
  function popularFiltros(){
    ["editMarca","editModelo","editSub","editAno"].forEach(id=>$(id).innerHTML="<option value=''>-- todos --</option>");
    
    // Filtros planos (popula com todas as op√ß√µes existentes no banco)
    const marcasUn = [...new Set(userDB.map(v=>v.marca))].sort();
    const modelosUn = [...new Set(userDB.map(v=>v.modelo))].sort();
    const subsUn = [...new Set(userDB.map(v=>v.submodelo).filter(x=>x))].sort();
    const anosUn = [...new Set(userDB.map(v=>v.ano))].sort();
    
    marcasUn.forEach(v=>addOpt('editMarca',v)); 
    modelosUn.forEach(v=>addOpt('editModelo',v));
    subsUn.forEach(v=>addOpt('editSub',v));
    anosUn.forEach(v=>addOpt('editAno',v));
  }

  function renderLista(lista=null){
    lista = lista || userDB;
    let c = $("listaVeiculos"); c.innerHTML = "";
    if(!lista.length){ c.innerHTML = "<i>Nenhum ve√≠culo encontrado</i>"; return; }
    lista.forEach((v) => {
      let d = document.createElement("div");
      d.style = "padding:10px 0;border-bottom:1px solid #ddd;";
      let qtdOpcoes = v.instalacoes ? v.instalacoes.length : 1;
      
      d.innerHTML = `
      <div style='display:flex;align-items:center;justify-content:space-between'>
        <div>
           <strong>${v.marca} ${v.modelo}</strong> (${v.ano})<br>
           <span style="font-size:12px;color:#666">${qtdOpcoes} local(is) | ${v.submodelo || ''}</span>
        </div>
        <div style="display:flex; gap:8px;">
            <button class='btn btn-sec' onclick="editarVeiculo('${v.id}')">Editar</button>
            <button class='btn btn-danger' onclick="removerVeiculo('${v.id}')">Excluir</button>
        </div>
      </div>`;
      c.appendChild(d);
    });
  }

  $("editTipo").onchange = filtrarEdicao;
  $("editMarca").onchange = filtrarEdicao;
  $("editModelo").onchange = filtrarEdicao;
  $("editSub").onchange = filtrarEdicao;
  $("editAno").onchange = filtrarEdicao;
</script>
</body>
</html>
