<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fio Certo</title>
<style>
:root{
  --bg:#f3f6fb; --card:#ffffff; --muted:#6b7280; --accent:#0ea5a3; --accent-darker:#0b8f8c;
  --btn:#0369a1; --success:#10b981; --danger:#ef4444; --radius:12px; --glass: rgba(255,255,255,0.7);}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#e6eef7,var(--bg));color:#0f172a;}
.container{max-width:980px;margin:28px auto;padding:20px;}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;}
.title{display:flex;gap:12px;align-items:center;}
.logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-darker));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;}
h1{font-size:20px;margin:0} .subtitle{color:var(--muted);font-size:13px;}
.grid{display:grid;grid-template-columns: 1fr 420px;gap:18px;}
.card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow: 0 6px 20px rgba(15,23,42,0.06);}
label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
select,input{width:100%;padding:10px 12px;margin-top:6px;border-radius:10px;border:1px solid #e6eef7;background:var(--glass);font-size:14px;}
.row{display:flex;gap:10px;align-items:center;margin-top:12px}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;}
.btn-primary{background:var(--btn);color:white;box-shadow:0 8px 18px rgba(3,105,161,0.12)}
.btn-primary:hover{background:#054b73}
.btn-sec{background:#fff;border:1px solid #e6eef7}
.btn-green{background:var(--success);color:white}
.btn-danger{background:var(--danger);color:white}
.small{font-size:13px;color:var(--muted);}
.resultTitle{font-weight:700;margin:0 0 6px 0}

/* --- Estilo para o Aviso de Limpeza --- */
.info-alert {
    margin-top: 20px;
    padding: 12px;
    background: #fffaeb; /* Amarelo muito claro */
    border: 1px solid #fcd34d; /* Amarelo m√©dio */
    color: #b45309; /* Marrom escuro */
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
}
/* NOVO ESTILO PARA O RESULTADO */
.resultBox {
    background: var(--card); 
    padding: 18px; /* Aumentei um pouco o padding */
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08); 
    font-family: Inter, sans-serif; 
    color: #0f172a; 
    min-height: 250px; /* Garante que a caixa tenha um tamanho m√≠nimo */
}
/* Novo estilo para cada item de fia√ß√£o */
.wire-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0; /* Aumentei o espa√ßamento */
    border-bottom: 1px dashed #e2e8f0;
}
.wire-item:last-child {
    border-bottom: none;
}
.wire-label {
    font-size: 16px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}
.wire-value {
    font-size: 16px;
    font-weight: 700;
    color: #0f172a; 
}
/* Cores de destaque */
.positivo-val { color: #000000; font-size: 18px; font-weight: 700; } 
.negativo-val { color: #000000; } 
.poschave-val { color: #000000; } 
.bloqueio-val { color: #000000; } 

/* T√≠tulo principal do Ve√≠culo/Local */
.main-title-box {
    background: #eff6ff;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 700;
    color: #1e40af;
}

/* ESTILOS DO HIST√ìRICO EXPANDIDO */
.history-details {
    display: none; /* Oculto por padr√£o */
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin-top: 8px;
    font-size: 13px;
    color: #334155;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
}
.history-details p { margin: 4px 0; }
.history-wire-group {
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f1f5f9;
}
.history-wire-group:last-child { border-bottom: none; }

/* Adicionado para compara√ß√£o no hist√≥rico */
.comparison-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 10px;
}
.comparison-box {
    border: 1px solid #e6eef7;
    background: #fdfdfd;
    padding: 10px;
    border-radius: 8px;
}
.comparison-box h4 {
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 14px;
    color: #4a5568;
    border-bottom: 1px dashed #e2e8f0;
    padding-bottom: 5px;
}
.changed-field {
    color: #c52438; /* Cor para indicar mudan√ßa */
    font-weight: 600;
    background-color: #ffeaea;
    padding: 1px 3px;
    border-radius: 3px;
}
.history-install-item {
    background: #f1f5f9;
    padding: 6px;
    border-radius: 6px;
    margin-top: 4px;
    font-size: 12px;
    margin-bottom: 6px;
}
.history-install-item strong { color: #334155; }
.history-install-item span { color: #64748b; }

/* NOVO: Estilo para o box de filtros do hist√≥rico */
#historicoModal > div:nth-child(3) {
    background: #f1f5f9; 
    padding: 12px; 
    border-radius: 8px; 
    margin-bottom: 15px;
}

/* MODAL & OVERLAY */
#overlay{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:60}
#modal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:500px;max-width:94%;z-index:70;border-radius:12px;padding:18px;background:var(--card);box-shadow:0 20px 60px rgba(2,6,23,0.25);max-height:90vh;overflow:auto}

/* Estilos para Modais de Senha/Auth/Hist√≥rico */
#historicoPasswordModal, #modalAlterarSenha {
    display: none; 
    position: fixed; 
    left: 50%; 
    top: 50%; 
    transform: translate(-50%,-50%); 
    width: 350px; 
    max-width: 94%; 
    z-index: 80; 
    border-radius: 12px; 
    padding: 18px; 
    background: var(--card); 
    box-shadow: 0 20px 60px rgba(2,6,23,0.25); 
}
#historicoModalOverlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.45);
    z-index: 60;
}
#historicoModal{
    display:none;
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:700px;
    max-width:94%;
    z-index:70;
    border-radius:12px;
    padding:18px;
    background:var(--card);
    box-shadow:0 20px 60px rgba(2,6,23,0.25);
    max-height:90vh;
    overflow:auto
}


.modalHeader{display:flex;justify-content:space-between;align-items:center; margin-bottom: 10px;}
.modalClose{background:transparent;border:none;color:var(--muted);font-weight:700;cursor:pointer}
.note{font-size:13px;color:var(--muted);margin-top:6px}

/* INSTALA√á√ïES NO MODAL */
.install-list { margin-top: 15px; border-top: 1px solid #e6eef7; padding-top: 10px; }
.install-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.install-item strong { display: block; font-size: 14px; color: #334155; }
.install-item span { font-size: 12px; color: #64748b; }
.section-title { font-size: 14px; font-weight: 700; color: var(--accent-darker); margin-top: 20px; border-bottom: 2px solid #e6eef7; padding-bottom: 5px; margin-bottom: 10px; }

/* TOAST NOTIFICATIONS */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; display: flex; align-items: center; animation: slideIn 0.3s ease; min-width: 250px;}
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.info { background: var(--btn); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* AUTOCOMPLETE SUGGESTIONS */
.suggestions-box { position: absolute; background: white; width: 100%; border: 1px solid #e2e8f0; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 50; margin-top: 2px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
.suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
.suggestion-item:hover { background: #f1f5f9; }
.relative { position: relative; }

/* OR SEPARATOR STYLE */
.separator-box { margin: 15px 0; border-bottom: 1px solid #e6eef7; position: relative; text-align: center; }
.separator-text { background: white; padding: 0 10px; color: #999; font-size: 12px; position: relative; top: 8px; }

/* FOOTER NOTICE */
.footer-notice {
    max-width: 980px;
    margin: 20px auto 30px auto;
    padding: 15px;
    text-align: center;
    font-size: 14px;
    color: var(--muted);
    background: #e6eef7; /* Fundo azul/cinza claro */
    border-radius: 10px;
    border: 1px solid #c9dff7;
}
.footer-notice a {
    color: var(--btn);
    font-weight: 600;
    text-decoration: none;
}

/* NOVO: Estilo para o Dropdown Menu */
.dropdown-menu-container {
    position: relative;
    display: inline-block;
}
.menu-toggle-btn {
    /* Novo bot√£o para abrir o menu */
    padding: 10px 14px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: #ffffff; /* Fundo branco ou neutro */
    border: 1px solid #e6eef7;
    color: var(--btn);
}
.dropdown-menu {
    position: absolute;
    top: 100%; /* Abaixo do bot√£o */
    right: 0;
    background: var(--card);
    border: 1px solid #e6eef7;
    border-radius: var(--radius);
    box-shadow: 0 8px 16px rgba(15,23,42,0.1);
    min-width: 200px;
    z-index: 100;
    margin-top: 8px; /* Espa√ßo entre o bot√£o e o menu */
    display: none; /* Oculto por padr√£o */
    padding: 8px 0;
}
.dropdown-menu button {
    display: block;
    width: 100%;
    padding: 10px 15px;
    text-align: left;
    background: transparent;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: #334155;
    font-size: 14px;
}
.dropdown-menu button:hover {
    background: #f1f5f9;
}
.dropdown-menu .separator {
    height: 1px;
    background: #e6eef7;
    margin: 8px 0;
}


@media (max-width:900px){.grid{grid-template-columns:1fr; }.title h1{font-size:18px}}
</style>
</head>
<body>

<div id="toast-container" class="toast-container"></div>

<div class="container">

  <div class="header">
    <div class="title">
      <div class="logo">FC</div>
      <div>
        <h1>Fio Certo</h1>
        <div class="subtitle">Padr√µes de cores e locais para instala√ß√£o de rastreadores (Online)</div>
      </div>
    </div>
    <div style="display:flex; gap: 12px; align-items: center;">
      
      <button class="btn btn-primary" id="loginRegisterButton" onclick="abrirModalAuth()">Login / Cadastrar</button>
      
      <div class="dropdown-menu-container" id="menuDropdownContainer" style="display:none;">
          
          <button class="menu-toggle-btn" onclick="toggleMenu()">Menu ‚ñº</button>
          
          <div class="dropdown-menu" id="userMenuDropdown">
              <button id="btnCadastrarVeiculoMenu" onclick="abrirCadastro(); toggleMenu();">‚ûï Cadastrar Ve√≠culo/Rastreador</button>
              
              <button id="editButtonMenu" onclick="abrirEditar(); toggleMenu();">üìù Editar Ve√≠culo/Rastreador</button>
              
              <button id="historicoButtonMenu" onclick="abrirHistorico(); toggleMenu();">‚è≥ Hist√≥rico de altera√ß√µes</button>
              
              <div class="separator"></div>

              <button id="alterarSenhaButtonMenu" onclick="abrirModalAlterarSenha(); toggleMenu();">üîë Alterar Senha</button>
              
              <button id="logoutButtonMenu" onclick="fazerLogout(); toggleMenu();">üö™ Logout</button>
              
          </div>
      </div>
      
    </div>
  </div>

  <div class="grid" id="gridPrincipal">
    <div class="card">
        
      <label style="color:var(--accent-darker); font-weight:700">üîç Busca R√°pida</label>
      <div class="relative">
          <input id="mainSearchInput" placeholder="Digite ex: Uno Way 2020..." autocomplete="off">
          <div id="mainSuggestions" class="suggestions-box"></div>
      </div>

      <div class="separator-box">
          <span class="separator-text">OU FILTRE ABAIXO</span>
      </div>

      <label>Tipo do ve√≠culo ou rastreador</label>
      <select id="tipoSelect">
        <option value="">-- selecione --</option>
        <option value="carro">Carro</option>
        <option value="moto">Moto</option>
        <option value="caminhao">Caminh√£o</option>
        <option value="rastreador">Rastreador</option>
      </select>

      <div id="marcaWrap" style="display:none">
        <label>Marca</label>
        <select id="marcaSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="modeloWrap" style="display:none">
        <label>Modelo</label>
        <select id="modeloSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="subWrap" style="display:none">
        <label>Submodelo</label>
        <select id="submodeloSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="anoWrap" style="display:none">
        <label>Ano</label>
        <select id="anoSelect"><option value="">-- selecione --</option></select>
      </div>

      <div class="row" style="margin-top:16px">
        <button class="btn btn-primary" onclick="buscar()">Buscar</button>
        <button class="btn btn-sec" onclick="resetBusca()">Limpar</button>
      </div>
      
      <div class="info-alert">
          üí°  Aviso: Sempre que for fazer uma nova busca ou usar o filtro, aperte no bot√£o "Limpar".
      </div>
      
    </div>

    <div class="card">
      <h3 class="resultTitle">Resultado</h3>
      
      <div id="seletorLocalWrap" style="display:none; margin-bottom: 15px; padding: 10px; background: #eff6ff; border-radius: 8px;">
        <label id="seletorLocalTitle" style="color: #1e3a8a; font-weight: bold; margin-top:0;">Op√ß√£o de Local de Instala√ß√£o:</label>
        <select id="resultadoLocalSelect" style="background: white; border: 1px solid #bfdbfe; color: #1e3a8a; font-weight: 600;">
        </select>
      </div>

      <div id="resultado" class="resultBox">Sistema pronto. Fa√ßa sua busca.</div>
      
      <div id="btnEditarResultado" style="margin-top:10px;text-align:right;display:none">
         </div>
    </div>
  </div>

  <div id="editarAba" style="display:none;">
    <div class="card">
      <div class="row" style="justify-content:flex-end;margin-bottom:8px;">
        <button class="btn btn-sec" onclick="voltarBusca()">Voltar √† Busca</button>
      </div>
      
      <h3>Gerenciar Ve√≠culos e Rastreadores</h3>

      <label style="color:var(--accent-darker); font-weight:700">üîç Busca R√°pida (Lista)</label>
      <input id="editSearchInput" placeholder="Digite ex: Honda Civic 2020..." onkeyup="filtrarEdicao()">

      <div class="separator-box">
          <span class="separator-text">OU FILTRE ABAIXO</span>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px">
          <div>
            <label>Tipo</label>
            <select id="editTipo" style="margin-top:0">
              <option value="">-- todos --</option>
              <option value="carro">Carro</option>
              <option value="moto">Moto</option>
              <option value="caminhao">Caminh√£o</option>
              <option value="rastreador">Rastreador</option>
            </select>
          </div>
          <div>
              <label>Marca</label>
              <select id="editMarca" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div>
              <label>Modelo</label>
              <select id="editModelo" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div id="editSubWrap">
              <label>Submodelo</label>
              <select id="editSub" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div>
              <label>Ano</label>
              <select id="editAno" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
      </div>

      <div id="listaVeiculos" style="margin-top:12px;"></div>
    </div>
  </div>

</div> <div class="footer-notice">
    Para o cadastro e edi√ß√£o dos ve√≠culos ou rastreadores, entre em contato com o email: 
    <a href="mailto:fiocertorastreadores@gmail.com">fiocertorastreadores@gmail.com</a>
</div>

<div id="overlay"></div>

<div id="modal">
  <div class="modalHeader">
    <strong id="modalTitle">Cadastrar ve√≠culo</strong>
    <button class="modalClose" onclick="fecharModal()">X</button>
  </div>
  <p class="note">Preencha os dados do ve√≠culo ou rastreador e adicione as op√ß√µes de instala√ß√£o.</p>

  <div class="section-title">1. Dados do Ve√≠culo ou Rastreador</div>
  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
      <div>
        <label>Tipo</label>
        <select id="addTipo">
          <option value="carro">Carro</option>
          <option value="moto">Moto</option>
          <option value="caminhao">Caminh√£o</option>
          <option value="rastreador">Rastreador</option>
        </select>
      </div>
      <div><label>Marca</label><select id="addMarca"></select></div>
  </div>
  <label>Modelo</label><input id="addModelo">
  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
    <div id="addSubmodeloWrap">
        <label>Submodelo</label><input id="addSubmodelo">
    </div>
    <div><label>Ano</label><input id="addAno" type="number"></div>
  </div>

  <div class="section-title" id="section2Title">2. Adicionar Op√ß√£o de Instala√ß√£o</div>
  <div style="background: #f1f5f9; padding: 12px; border-radius: 8px;">
      
      <div id="localDetalheFields">
          <label style="color:#0f172a; font-weight:700">Nome do Local (Ex: Caixa de Fus√≠veis)</label>
          <input id="addNomeLocal" placeholder="Ex: Painel, Caixa de Fus√≠veis, Airbag...">
          
          <label>Local Detalhado (Opcional)</label>
          <input id="addLocalDetalhe" placeholder="Ex: Abaixo do volante, fio grosso">
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
        <div><label>Positivo</label><input id="addPositivo"></div>
        <div><div><label>Negativo</label><input id="addNegativo"></div></div>
      </div>
      <div class="grid" id="posChaveBloqueioGrid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
        <div><label>P√≥s-chave</label><input id="addPosChave"></div>
        <div><label id="output1Label">Bloqueio</label><input id="addBloqueio"></div>
      </div>

      <div id="trackerSpecificFields" style="display:none;">
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
              <div><label>Saida 2</label><input id="addSaida2"></div>
              <div><label>Entrada 1</label><input id="addEntrada1"></div>
          </div>
          <div><label>Entrada 2</label><input id="addEntrada2"></div>
      </div>

      <button class="btn btn-sec" style="width:100%; margin-top:10px; border-color:var(--accent); color:var(--accent-darker)" onclick="adicionarInstalacaoNaLista()">+ Adicionar esta Op√ß√£o</button>
  </div>

  <div class="section-title">Op√ß√µes Adicionadas (<span id="countInstalacoes">0</span>)</div>
  <div id="listaInstalacoesAdd" class="install-list">
      <div style="text-align:center; color:var(--muted); font-size:13px;">Nenhuma op√ß√£o adicionada ainda.</div>
  </div>

  <div class="row" style="justify-content:flex-end;margin-top:14px; border-top: 2px solid #ddd; padding-top:10px;">
    <button class="btn btn-sec" onclick="fecharModal()">Cancelar</button>
    <button class="btn btn-green" id="btnSalvar">Salvar Ve√≠culo ou Rastreador Completo</button>
  </div>
</div>
<div id="historicoPasswordModal">
    <div class="modalHeader">
      <strong>Acesso Restrito ao Hist√≥rico</strong>
      <button class="modalClose" onclick="fecharHistoricoPasswordModal()">X</button>
    </div>
    <p class="note">Insira o c√≥digo secreto para visualizar o Hist√≥rico de altera√ß√µes.</p>
    
    <label>C√≥digo Secreto</label>
    <input id="historicoSenhaInput" type="password" placeholder="Seu c√≥digo secreto (N√£o √© a senha de login)">
    
    <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="verificarSenhaHistorico()">Acessar Hist√≥rico</button>
</div>
<div id="modalAlterarSenha">
  <div class="modalHeader">
    <strong>Alterar Senha de Login</strong>
    <button class="modalClose" onclick="fecharModalAlterarSenha()">X</button>
  </div>
  <p class="note">Mude sua senha de **Login** no sistema.</p>
  
  <label>Senha Atual</label>
  <input id="currentPasswordInput" type="password" placeholder="Sua senha atual">

  <label style="margin-top:15px;">Nova Senha</label>
  <input id="newPasswordInput" type="password" placeholder="M√≠nimo 6 caracteres">
  
  <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="alterarSenha()">Confirmar Altera√ß√£o</button>
</div>
<div id="historicoModalOverlay"></div>
<div id="historicoModal">
  <div class="modalHeader">
    <strong>Hist√≥rico de A√ß√µes</strong>
    <button class="modalClose" onclick="fecharHistoricoModal()">X</button>
  </div>
  <p class="note">Registro de cadastros, edi√ß√µes e exclus√µes no banco de dados. Filtros aplicados sobre todos os itens carregados.</p>
  
  <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
    <label style="color:var(--accent-darker); font-weight:700">üîç Buscar por Ve√≠culo/Detalhe</label>
    <input id="historySearchInput" placeholder="Ex: Uno Way 2020 ou fio amarelo" onkeyup="filtrarHistorico()">

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px">
      <div>
        <label>Tipo de A√ß√£o</label>
        <select id="historyTipoSelect" onchange="filtrarHistorico()" style="margin-top:0">
          <option value="">-- todos --</option>
          <option value="CADASTRO">Cadastro</option>
          <option value="EDICAO">Edi√ß√£o</option>
          <option value="EXCLUSAO">Exclus√£o</option>
        </select>
      </div>
      <div>
        <label>Usu√°rio</label>
        <select id="historyUserSelect" onchange="filtrarHistorico()" style="margin-top:0">
          <option value="">-- todos --</option>
        </select>
      </div>
      
      <div>
        <label>Data (A partir de)</label>
        <input id="historyDateStart" type="date" onchange="filtrarHistorico()" style="margin-top:0">
      </div>
      <div>
        <label>Data (At√©)</label>
        <input id="historyDateEnd" type="date" onchange="filtrarHistorico()" style="margin-top:0">
      </div>
      
    </div>
  </div>
  <div id="historicoLista">Carregando hist√≥rico...</div>
  
  <div style="text-align:center; margin-top: 15px;">
    <button class="btn btn-sec" id="btnCarregarMaisHistorico" onclick="fetchHistoryBatch(false)" style="display:none; width: 100%;">Carregar Mais 50 Registros Antigos</button>
  </div>
  <p id="historyEndMessage" class="small" style="text-align:center; margin-top: 10px; color:var(--success); display:none;">Fim do Hist√≥rico Carregado</p>

</div>
<div id="modalAuth" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:350px; max-width:94%; z-index:80; border-radius:12px; padding:18px; background:var(--card); box-shadow:0 20px 60px rgba(2,6,23,0.25); max-height:90vh; overflow:auto">
  <div class="modalHeader">
    <strong id="authModalTitle">Login / Cadastro</strong>
    <button class="modalClose" onclick="fecharModalAuth()">X</button>
  </div>
  
  <label>Email</label>
  <input id="authEmail" type="email" placeholder="seu.email@exemplo.com">

  <label>Senha</label>
  <input id="authSenha" type="password" placeholder="M√≠nimo 6 caracteres">
  
  <label style="margin-top:15px; color:var(--danger)">C√≥digo de Cadastro (Obrigat√≥rio para Criar Conta)</label>
  <input id="authCode" type="text" placeholder="Solicite o c√≥digo secreto">

  <div class="row" style="margin-top:20px; justify-content:space-between">
    <button class="btn btn-primary" id="btnLogin" onclick="handleLogin()">Login</button>
    <button class="btn btn-sec" id="btnRegister" onclick="handleRegister()">Cadastrar</button>
  </div>
</div>
<script type="module">
  /* ================= FIREBASE SETUP ================= */
  // CORRE√á√ÉO ESSENCIAL: Adicionando importa√ß√£o de initializeApp
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
  // IMPORT ATUALIZADO: Adicionando 'startAfter' para pagina√ß√£o
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB097Hr3Vg55djiCjW8A3m_vhK4Jen-Xlw",
    authDomain: "fiocertorastreador.firebaseapp.com",
    projectId: "fiocertorastreador",
    storageBucket: "fiocertorastreador.firebasestorage.app",
    messagingSenderId: "735489114974",
    appId: "1:735489114974:web:40820bcec28e2b252fc5cf",
    measurementId: "G-2P8HSDLBLZ"
  };

  const app = initializeApp(firebaseConfig);
  const dbFirestore = getFirestore(app);
  const veiculosCollection = collection(dbFirestore, "veiculos");
  const historicoAcoesCollection = collection(dbFirestore, "historico_acoes"); 
  const auth = getAuth(app);

  /* ================= VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ÉO DE SENHA SECRETA ================= */
  let userDB = []; 
  let loggedInUser = null; 
  let db = [];
  let editarIndex = null;
  let oldVehicleData = null; 
  let tempInstalacoes = [];
  let currentVehicleResult = null;
  let historyData = []; // Armazena o hist√≥rico completo carregado (agora com pagina√ß√£o)

  // NOVO: Vari√°veis de controle para Pagina√ß√£o do Hist√≥rico
  const HISTORY_BATCH_SIZE = 50; 
  let lastVisibleHistoryDoc = null; 
  let hasMoreHistory = true; 
  let isLoadingHistory = false; // Para evitar m√∫ltiplos cliques de "Carregar Mais"

  
  // =========================================================================
  // !!! ATEN√á√ÉO: SENHA SECRETA DO HIST√ìRICO !!!
  // Mude este valor para o c√≥digo que s√≥ voc√™ saber√°.
  const HISTORY_SECRET_CODE = "112512"; 
  // =========================================================================

  const marcas = {
    carro:["Fiat","Volkswagen","Chevrolet","Toyota","Ford","Renault","Peugeot","Citro√´n","Honda","Hyundai","Land Rover","Ram","BYD"],
    moto:["Honda","Yamaha","Suzuki","BMW","Shineray","Dafra","Kawasaki"],
    caminhao:["Volvo","Scania","Mercedes-Benz","Volkswagen Caminh√µes","Iveco","Ford","Renault Trucks","Hyundai HR / Kia Bongo"],
    rastreador:["Suntech", "Ituran", "Positron", "Cobli", "Tracker Brasil", "X3Tech"]
  };

  const $ = id => document.getElementById(id);

  /* ================= NOTIFICATION SYSTEM (TOAST) ================= */
  window.showNotification = function(message, type = 'info') {
      const container = $("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      
      let icon = '';
      if(type === 'success') icon = '‚úÖ ';
      if(type === 'error') icon = '‚ùå ';
      if(type === 'info') icon = '‚ÑπÔ∏è ';

      toast.innerHTML = `<span>${icon} ${message}</span>`;
      container.appendChild(toast);

      setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          toast.style.transition = 'all 0.3s ease';
          setTimeout(() => toast.remove(), 300);
      }, 3500);
  };
  
  /* ================= MODAL AUTH FUNCTIONS ================= */
  
  window.abrirModalAuth = function() {
    $("overlay").style.display = "block";
    $("modalAuth").style.display = "block";
  };

  window.fecharModalAuth = function() {
    $("overlay").style.display = "none";
    $("modalAuth").style.display = "none";
    $("authEmail").value = "";
    $("authSenha").value = "";
    $("authCode").value = ""; 
  };

  /* ================= FIREBASE AUTH FUNCTIONS ================= */
  
  const SECRET_CODE = "fiocerto2025"; 

  window.handleRegister = function() {
    const email = $("authEmail").value;
    const senha = $("authSenha").value;
    const code = $("authCode").value.trim(); 

    if (code !== SECRET_CODE) {
        showNotification('C√≥digo de Cadastro incorreto. Solicite o c√≥digo.', 'error');
        return;
    }

    createUserWithEmailAndPassword(auth, email, senha)
        .then(() => {
            showNotification('Cadastro realizado e Login efetuado!', 'success');
            fecharModalAuth();
        })
        .catch((error) => {
            console.error(error);
            showNotification('Erro no cadastro: ' + error.message.replace("Firebase: ", ""), 'error');
        });
  };

  window.handleLogin = function() {
    const email = $("authEmail").value;
    const senha = $("authSenha").value;
    signInWithEmailAndPassword(auth, email, senha)
        .then(() => {
            showNotification('Login realizado com sucesso!', 'success');
            fecharModalAuth();
        })
        .catch((error) => {
            console.error(error);
            showNotification('Erro no login: ' + error.message.replace("Firebase: ", ""), 'error');
        });
  };

  window.fazerLogout = function() {
      signOut(auth)
          .then(() => {
              showNotification('Sess√£o encerrada.', 'info');
          })
          .catch((error) => {
              showNotification('Erro ao fazer logout.', 'error');
          });
  };

  /* ================= DROPDOWN MENU LOGIC (NOVO) ================= */
  
  window.toggleMenu = function() {
    const dropdown = $("userMenuDropdown");
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
  };
  
  // Fecha o menu se o usu√°rio clicar fora dele
  document.addEventListener('click', (event) => {
      const dropdownContainer = $("menuDropdownContainer");
      const dropdown = $("userMenuDropdown");

      if (dropdownContainer && !dropdownContainer.contains(event.target)) {
          if (dropdown && dropdown.style.display === "block") {
              dropdown.style.display = "none";
          }
      }
  });


  function updateUIAuth(user) {
      const loginRegisterBtn = $("loginRegisterButton");
      const menuDropdownContainer = $("menuDropdownContainer"); 

      if (user) {
          loginRegisterBtn.style.display = "none";
          menuDropdownContainer.style.display = "inline-block"; // Mostra o menu de a√ß√µes
          const dropdown = $("userMenuDropdown");
          if (dropdown) dropdown.style.display = "none"; // Garante que o menu esteja fechado
      } else {
          loginRegisterBtn.style.display = "inline-block";
          menuDropdownContainer.style.display = "none"; // Esconde o menu de a√ß√µes
          voltarBusca(); 
      }
  }
  
  /* ================= ALTERAR SENHA FIREBASE (LOGIN) ================= */
  window.abrirModalAlterarSenha = function() {
      if (!loggedInUser) {
         showNotification("Fa√ßa login para alterar a senha.", "error");
         return;
      }
      $("historicoModalOverlay").style.display = "block"; 
      $("modalAlterarSenha").style.display = "block";
      $("currentPasswordInput").value = "";
      $("newPasswordInput").value = "";
      $("currentPasswordInput").focus();
  };
  
  window.fecharModalAlterarSenha = function() {
      $("historicoModalOverlay").style.display = "none";
      $("modalAlterarSenha").style.display = "none";
  };
  
  window.alterarSenha = async function() {
      const senhaAtual = $("currentPasswordInput").value;
      const novaSenha = $("newPasswordInput").value;
      
      if (!senhaAtual || !novaSenha) {
          showNotification("Preencha todos os campos.", "error");
          return;
      }
      
      if (novaSenha.length < 6) {
          showNotification("A nova senha deve ter no m√≠nimo 6 caracteres.", "error");
          return;
      }
      
      if (senhaAtual === novaSenha) {
          showNotification("A nova senha deve ser diferente da atual.", "error");
          return;
      }
      
      const btn = document.querySelector("#modalAlterarSenha .btn-primary");
      btn.innerText = "Verificando...";
      btn.disabled = true;

      try {
          const credential = EmailAuthProvider.credential(loggedInUser.email, senhaAtual);
          
          await reauthenticateWithCredential(loggedInUser, credential);
          await updatePassword(loggedInUser, novaSenha);
          
          showNotification("Sua senha de login foi alterada com sucesso!", "success");
          fecharModalAlterarSenha();
          fazerLogout(); 
          
      } catch (error) {
          console.error("Erro ao alterar senha:", error);
          if (error.code === 'auth/wrong-password') {
               showNotification("Senha atual incorreta.", "error");
          } else if (error.code === 'auth/requires-recent-login') {
               showNotification("Por seguran√ßa, fa√ßa login novamente e tente a altera√ß√£o.", "error");
          } else {
               showNotification("Erro ao alterar senha. Verifique os dados.", "error");
          }
      } finally {
          btn.innerText = "Confirmar Altera√ß√£o";
          btn.disabled = false;
      }
  };


  /* ================= HIST√ìRICO DE A√á√ïES - CONTROLE DE ACESSO (SENHA SECRETA) ================= */
  
  window.abrirHistorico = function() {
      if (!loggedInUser) {
         showNotification("Fa√ßa login para ver o hist√≥rico.", "error");
         return;
      }
      $("historicoPasswordModal").style.display = "block";
      $("historicoModalOverlay").style.display = "block";
      $("historicoSenhaInput").value = "";
      $("historicoSenhaInput").focus();
  };
  
  window.fecharHistoricoPasswordModal = function() {
      $("historicoPasswordModal").style.display = "none";
      $("historicoModalOverlay").style.display = "none";
  };
  
  window.fecharHistoricoModal = function() {
      $("historicoModalOverlay").style.display = "none";
      $("historicoModal").style.display = "none";
      historyData = []; 
      lastVisibleHistoryDoc = null; 
      hasMoreHistory = true; 
      // Limpa os filtros
      $("historySearchInput").value = "";
      $("historyTipoSelect").value = "";
      $("historyUserSelect").value = "";
      $("historyDateStart").value = "";
      $("historyDateEnd").value = ""; 
  };

  
  window.verificarSenhaHistorico = async function() {
      const senhaDigitada = $("historicoSenhaInput").value.trim();
      
      if (!senhaDigitada) {
          showNotification("O c√≥digo secreto √© obrigat√≥rio.", "error");
          return;
      }
      
      // *** VERIFICA√á√ÉO DO C√ìDIGO SECRETO FIXO ***
      if (senhaDigitada === HISTORY_SECRET_CODE) { 
          fecharHistoricoPasswordModal();
          $("historicoModalOverlay").style.display = "block";
          $("historicoModal").style.display = "block";
          await carregarHistorico();
      } else {
          showNotification("C√≥digo secreto incorreto. Acesso negado.", "error");
      }
  };


  // Salva o objeto DADOS completo e DADOS ANTIGOS (se for edi√ß√£o)
  async function registrarAcao(tipo, dados, dadosAntigos = null) {
      if (!loggedInUser) return; 

      try {
          const acao = {
              tipo: tipo, // CADASTRO, EDICAO, EXCLUSAO
              dados_completos: dados, 
              dados_antigos: dadosAntigos, // NOVO: Para compara√ß√£o na edi√ß√£o
              
              veiculo_marca: dados.marca,
              veiculo_modelo: dados.modelo,
              veiculo_ano: dados.ano,
              
              usuario: loggedInUser.email, 
              data: new Date().toISOString()
          };
          await addDoc(historicoAcoesCollection, acao);
      } catch (e) {
          console.error("Erro ao registrar a√ß√£o no hist√≥rico: ", e);
      }
  }

  window.toggleHistoryDetails = function(id) {
      const detailsDiv = document.getElementById('details-' + id);
      if (detailsDiv.style.display === 'none') {
          detailsDiv.style.display = 'block';
      } else {
          detailsDiv.style.display = 'none';
      }
  };

  // Helper para formatar os detalhes de instala√ß√£o (blocos)
  function renderInstalacoes(instalacoes, isNew, oldInstalacoes = []) {
      if (!instalacoes || instalacoes.length === 0) return '<div>Nenhuma instala√ß√£o cadastrada.</div>';
      
      let html = '';
      instalacoes.forEach((inst, idx) => {
          let changeFlag = '';
          
          if (isNew) {
              const oldInst = oldInstalacoes.find(o => 
                  o.nomeLocal === inst.nomeLocal && 
                  o.localDetalhe === inst.localDetalhe && 
                  o.positivo === inst.positivo &&
                  o.negativo === inst.negativo &&
                  o.posChave === inst.posChave &&
                  o.bloqueio === inst.bloqueio
              );
              if (!oldInst) changeFlag = ' **(NOVA)**';
          }

          const details = inst.localDetalhe || "Sem detalhes";
          let title = inst.nomeLocal;

          // Monta o item de instala√ß√£o
          html += `
          <div class="history-install-item">
              <strong>${title}</strong>${changeFlag}<br>
              <span style="display:block;">Pos: ${inst.positivo || '-'} | Neg: ${inst.negativo || '-'} | P√≥s-Chave: ${inst.posChave || '-'} | Bloqueio: ${inst.bloqueio || '-'}</span>
              ${inst.saida2 ? `<span style="display:block;">S2: ${inst.saida2 || '-'} | E1: ${inst.entrada1 || '-'} | E2: ${inst.entrada2 || '-'}</span>` : ''}
              ${details !== "Sem detalhes" && !inst.saida2 ? `<i>Detalhe: ${details}</i>` : ''}
          </div>`;
      });
      return html;
  }

  // Helper para renderizar dados em um √∫nico bloco (CADASTRO ou EXCLUSAO)
  function renderSingleDetails(dados, tipo) {
      const isRastreador = dados.tipo === 'rastreador';
      const labelSubmodelo = isRastreador ? "Modelo Rastreador" : "Submodelo";
      
      // Para rastreador, o submodelo/modelo rastreador fica no nomeLocal da primeira instala√ß√£o
      const valueSubmodelo = isRastreador ? dados.instalacoes?.[0]?.nomeLocal : dados.submodelo;

      let html = `<div style='margin-top:5px;'>`;
      html += `<b>Tipo:</b> ${dados.tipo || '-'}<br>`;
      html += `<b>Marca:</b> ${dados.marca || '-'}<br>`;
      html += `<b>Modelo:</b> ${dados.modelo || '-'}<br>`;
      html += `<b>${labelSubmodelo}:</b> ${valueSubmodelo || '-'}<br>`;
      html += `<b>Ano:</b> ${dados.ano || '-'}<br>`;
      html += `<div style='margin-top:8px;'><b>Instala√ß√µes (${dados.instalacoes?.length || 0}):</b></div>`;
      html += renderInstalacoes(dados.instalacoes, false); 
      html += `</div>`;
      return html;
  }
  
  // Helper para renderizar a compara√ß√£o (EDICAO)
  function renderComparisonDetails(antigo, novo) {
      const fields = ['tipo', 'marca', 'modelo', 'submodelo', 'ano'];
      const isRastreador = novo.tipo === 'rastreador';
      const labelSubmodelo = isRastreador ? "Modelo Rastreador" : "Submodelo";

      const getVal = (data, field) => {
          // Se for Rastreador, o "submodelo" √© o nomeLocal da primeira instala√ß√£o
          if (field === 'submodelo' && isRastreador) {
              return data.instalacoes?.[0]?.nomeLocal || '-';
          }
          return data[field] || '-';
      };

      let htmlAntigo = '<h4><span style="color:var(--danger)">Antes</span> da Edi√ß√£o</h4>';
      let htmlNovo = '<h4><span style="color:var(--success)">Depois</span> da Edi√ß√£o</h4>';

      // Compara√ß√£o dos campos b√°sicos
      fields.forEach(field => {
          const label = field === 'submodelo' ? labelSubmodelo : field.charAt(0).toUpperCase() + field.slice(1);
          const valAntigo = getVal(antigo, field);
          const valNovo = getVal(novo, field);
          const changed = valAntigo !== valNovo;

          const spanAntigo = changed ? `<span class="changed-field">${valAntigo}</span>` : valAntigo;
          const spanNovo = changed ? `<span class="changed-field">${valNovo}</span>` : valNovo;

          htmlAntigo += `<p><b>${label}:</b> ${spanAntigo}</p>`;
          htmlNovo += `<p><b>${label}:</b> ${spanNovo}</p>`;
      });

      // Compara√ß√£o das Instala√ß√µes (Aqui √© mais complexo, apenas listamos os blocos)
      htmlAntigo += `<div style='margin-top:10px;'><b>Instala√ß√µes (${antigo.instalacoes?.length || 0}):</b></div>`;
      htmlAntigo += renderInstalacoes(antigo.instalacoes, false);

      htmlNovo += `<div style='margin-top:10px;'><b>Instala√ß√µes (${novo.instalacoes?.length || 0}):</b></div>`;
      // Passamos as instala√ß√µes antigas para a nova fun√ß√£o para ela destacar as NOVAS (se for o caso)
      htmlNovo += renderInstalacoes(novo.instalacoes, true, antigo.instalacoes);


      return `
          <div class="comparison-container">
              <div class="comparison-box">${htmlAntigo}</div>
              <div class="comparison-box">${htmlNovo}</div>
          </div>
      `;
  }

  // Fun√ß√£o principal para formatar os detalhes do Hist√≥rico
  function formatarDetalhesHtml(acao) {
      const dados = acao.dados_completos;
      const dadosAntigos = acao.dados_antigos; 
      
      if (!dados) return "Sem detalhes salvos.";

      if (acao.tipo === 'EDICAO' && dadosAntigos) {
          return renderComparisonDetails(dadosAntigos, dados);
      }
      
      // Para CADASTRO e EXCLUSAO, mostramos os detalhes em um bloco √∫nico
      return renderSingleDetails(dados, acao.tipo);
  }

  // Renderiza a lista de hist√≥rico (usada ap√≥s carregar ou filtrar)
  function renderHistoricoLista(data) {
      const listaDiv = $("historicoLista");
      listaDiv.innerHTML = "";
      
      if (data.length === 0) {
          listaDiv.innerHTML = '<p style="text-align:center; color:var(--muted);">Nenhuma a√ß√£o encontrada com os filtros atuais.</p>';
          return;
      }
      
      let html = data.map((acao) => {
          const dataFormatada = new Date(acao.data).toLocaleString('pt-BR');
          const tipo = acao.tipo;
          const dadosVeiculo = acao.dados_completos || { marca: acao.veiculo_marca, modelo: acao.veiculo_modelo, ano: acao.veiculo_ano };
          
          let cor = '#0f172a';
          if (tipo === 'CADASTRO') cor = 'var(--success)';
          if (tipo === 'EDICAO') cor = 'var(--btn)';
          if (tipo === 'EXCLUSAO') cor = 'var(--danger)';
          
          const veiculoInfo = `${dadosVeiculo.marca} ${dadosVeiculo.modelo} (${dadosVeiculo.ano})`;
          
          return `
              <div style="border:1px solid #e2e8f0; padding:10px; border-radius:8px; margin-bottom:8px; background: #f8fafc;">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                      <div>
                          <strong style="color:${cor}; font-size:14px;">${tipo}</strong> | 
                          <span style="font-size:14px; font-weight:600;">${veiculoInfo}</span><br>
                          <span style="font-size:12px; color:var(--muted);">Por: ${acao.usuario} em ${dataFormatada}</span>
                      </div>
                      <button class="btn btn-sec" style="padding:4px 8px; font-size:12px;" onclick="toggleHistoryDetails('${acao.id}')">üëÅÔ∏è Detalhes</button>
                  </div>
                  
                  <div id="details-${acao.id}" class="history-details">
                      ${formatarDetalhesHtml(acao)}
                  </div>
              </div>
          `;
      }).join('');
      
      listaDiv.innerHTML = html;
  }

  // Aplica os filtros locais
  window.filtrarHistorico = function() {
      const termo = $("historySearchInput").value.toLowerCase().trim();
      const tipo = $("historyTipoSelect").value;
      const usuario = $("historyUserSelect").value;
      
      const dataInicio = $("historyDateStart").value; 
      const dataFim = $("historyDateEnd").value; 

      let dataInicioMs = 0;
      let dataFimMs = Infinity; 

      if (dataInicio) {
          // Cria um objeto Date para o in√≠cio do dia da data selecionada (para compara√ß√£o)
          const [year, month, day] = dataInicio.split('-');
          dataInicioMs = new Date(year, month - 1, day).getTime();
      }
      
      if (dataFim) {
          // Cria um objeto Date para o FINAL do dia da data selecionada (para compara√ß√£o)
          const [year, month, day] = dataFim.split('-');
          // Adiciona 24 horas - 1 milissegundo para pegar at√© o final do dia selecionado
          const dataFimObj = new Date(year, month - 1, day);
          dataFimMs = dataFimObj.getTime() + (24 * 60 * 60 * 1000) - 1; 
      }

      const filteredData = historyData.filter(acao => {
          // 1. Filtro por Tipo de A√ß√£o
          const matchTipo = !tipo || acao.tipo === tipo;

          // 2. Filtro por Usu√°rio
          const matchUsuario = !usuario || acao.usuario === usuario;

          // 3. Filtro por Data (INTERVALO)
          const acaoDateMs = new Date(acao.data).getTime(); 
          
          const matchDataInicio = !dataInicio || acaoDateMs >= dataInicioMs;
          const matchDataFim = !dataFim || acaoDateMs <= dataFimMs;
          
          const matchData = matchDataInicio && matchDataFim;


          // 4. Filtro por Texto (Ve√≠culo ou Detalhe do Fio)
          const veiculoInfo = `${acao.veiculo_marca} ${acao.veiculo_modelo} ${acao.veiculo_ano} ${acao.dados_completos?.submodelo || ''}`.toLowerCase();
          
          let fia√ß√£oInfo = '';
          if (acao.dados_completos?.instalacoes) {
              fia√ß√£oInfo = acao.dados_completos.instalacoes.map(inst => 
                  `${inst.nomeLocal} ${inst.localDetalhe} ${inst.positivo} ${inst.negativo} ${inst.posChave} ${inst.bloqueio} ${inst.saida2 || ''} ${inst.entrada1 || ''} ${inst.entrada2 || ''}`
              ).join(' ').toLowerCase();
          }

          const fullSearchString = veiculoInfo + fia√ß√£oInfo;
          // Usa 'split(" ").every' para busca mais inteligente (todos os termos devem estar presentes)
          const matchTermo = !termo || termo.split(" ").every(t => fullSearchString.includes(t)); 

          return matchTipo && matchUsuario && matchData && matchTermo;
      });

      renderHistoricoLista(filteredData);
  }


  // NOVO: Fun√ß√£o para buscar o hist√≥rico em lotes (pagina√ß√£o)
  window.fetchHistoryBatch = async function(isInitialLoad = false) {
    if (isLoadingHistory || (!hasMoreHistory && !isInitialLoad)) return;
    
    isLoadingHistory = true;
    const btn = $("btnCarregarMaisHistorico");
    const listaDiv = $("historicoLista");
    const historyEndMessage = $("historyEndMessage");
    
    historyEndMessage.style.display = "none";
    btn.innerText = isInitialLoad ? "Carregando..." : "Carregando mais...";
    btn.disabled = true;
    btn.style.display = "block"; 

    try {
        let q;
        if (lastVisibleHistoryDoc) {
            // Se houver um √∫ltimo documento vis√≠vel, busca a pr√≥xima p√°gina
            q = query(historicoAcoesCollection, 
                orderBy("data", "desc"), 
                startAfter(lastVisibleHistoryDoc), 
                limit(HISTORY_BATCH_SIZE));
        } else {
            // Primeira busca
            q = query(historicoAcoesCollection, 
                orderBy("data", "desc"), 
                limit(HISTORY_BATCH_SIZE));
        }
        
        const querySnapshot = await getDocs(q);
        const fetchedBatch = [];
        const uniqueUsers = new Set(); 
        
        querySnapshot.docs.forEach((doc, index) => {
            const acao = { id: doc.id, ...doc.data() };
            fetchedBatch.push(acao);
            historyData.push(acao); 
            uniqueUsers.add(acao.usuario);
            
            // O √∫ltimo documento do lote √© o ponto de partida para a pr√≥xima busca
            if (index === querySnapshot.docs.length - 1) {
                lastVisibleHistoryDoc = doc; 
            }
        });

        // 1. Verifica se h√° mais registros
        if (fetchedBatch.length < HISTORY_BATCH_SIZE) {
            hasMoreHistory = false;
        }

        // 2. Atualiza os filtros de usu√°rio
        const userSelect = $("historyUserSelect");
        // Cria um Set de todos os usu√°rios j√° carregados para evitar duplicatas no select
        const currentUsers = new Set(Array.from(userSelect.options).map(opt => opt.value).filter(v => v));
        
        historyData.forEach(acao => uniqueUsers.add(acao.usuario)); // Adiciona todos os usu√°rios do hist√≥rico
        
        Array.from(uniqueUsers).sort().forEach(user => {
            if (!currentUsers.has(user)) {
                let opt = document.createElement("option");
                opt.value = user;
                opt.text = user;
                userSelect.appendChild(opt);
            }
        });
        
        // 3. Se for a carga inicial e n√£o houver dados, mostra mensagem
        if (isInitialLoad && historyData.length === 0) {
            listaDiv.innerHTML = '<p style="text-align:center; color:var(--muted);">Nenhuma a√ß√£o registrada ainda.</p>';
        }

        // 4. Renderiza o hist√≥rico (que agora tem o lote antigo + o novo)
        filtrarHistorico(); 
        
        // 5. Atualiza o estado do bot√£o
        if (hasMoreHistory) {
            btn.innerText = `Carregar Mais ${HISTORY_BATCH_SIZE} Registros Antigos`;
            btn.disabled = false;
        } else {
            btn.style.display = "none";
            historyEndMessage.style.display = "block";
        }
        
        if (historyData.length === 0) {
             btn.style.display = "none";
        }

    } catch (e) {
        console.error("Erro ao carregar lote do hist√≥rico: ", e);
        showNotification("Erro ao carregar hist√≥rico. Tente novamente.", "error");
        if (isInitialLoad) {
             listaDiv.innerHTML = "<p style='color:var(--danger);'>Erro ao carregar hist√≥rico.</p>";
        }
        btn.innerText = "Erro ao Carregar. Clique para tentar.";
        btn.disabled = false;
    } finally {
        isLoadingHistory = false;
    }
}


  async function carregarHistorico() {
      const listaDiv = $("historicoLista");
      listaDiv.innerHTML = "Carregando hist√≥rico...";
      
      // Limpa estado para nova busca completa
      historyData = [];
      lastVisibleHistoryDoc = null; 
      hasMoreHistory = true; 
      
      // Limpa os filtros
      $("historySearchInput").value = "";
      $("historyTipoSelect").value = "";
      $("historyUserSelect").innerHTML = '<option value="">-- todos --</option>'; // Limpa e adiciona o padr√£o
      $("historyDateStart").value = "";
      $("historyDateEnd").value = ""; 
      
      // Chamada para a nova fun√ß√£o de fetch em lote (carga inicial)
      await fetchHistoryBatch(true);
  }

  /* ================= CARREGAMENTO INICIAL ================= */
  async function carregarDadosDoFirebase() {
    $("resultado").innerText = "Carregando banco de dados...";
    try {
      const querySnapshot = await getDocs(veiculosCollection);
      userDB = [];
      querySnapshot.forEach((doc) => {
        userDB.push({ id: doc.id, ...doc.data() });
      });
      db = [...userDB]; 
      $("resultado").innerText = "Sistema pronto. Fa√ßa sua busca.";
      if($("editarAba").style.display === "block") {
          popularFiltrosEdicao(db); 
          renderLista();
      }
    } catch (e) {
      console.error("Erro ao ler dados: ", e);
      $("resultado").innerText = "Erro ao conectar com servidor.";
      showNotification("Erro de conex√£o com o servidor", "error");
    }
  }

  /* ================= AUTH STATE LISTENER ================= */
  onAuthStateChanged(auth, (user) => {
      loggedInUser = user; 
      updateUIAuth(user);
      carregarDadosDoFirebase(); 
  });

  /* ================= UI FUNCTIONS ================= */
  
  window.abrirCadastro = function() {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para cadastrar ve√≠culos.", "error");
        return;
    }
    
    editarIndex = null;
    oldVehicleData = null; // Zera o dado antigo
    tempInstalacoes = [];
    renderTempInstalacoes();
    limparCamposInstalacao();
    
    $("modalTitle").innerText = "Cadastrar novo ve√≠culo/rastreador";
    $("addTipo").value = 'carro'; 
    handleTipoChange(); 
    
    ["addMarca", "addModelo", "addSubmodelo", "addAno"].forEach(id => $(id).value = '');
    
    $("overlay").style.display = "block";
    $("modal").style.display = "block";
  };

  window.fecharModal = function() {
    $("overlay").style.display = "none";
    $("modal").style.display = "none";
    editarIndex = null;
    oldVehicleData = null; 
    tempInstalacoes = [];
  };

  window.abrirEditar = function() {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para acessar a edi√ß√£o.", "error");
        return;
    }
    $("editarAba").style.display = "block";
    $("gridPrincipal").style.display = "none";
    popularFiltrosEdicao(db); 
    renderLista();
  };

  window.voltarBusca = function() {
    $("editarAba").style.display = "none";
    $("gridPrincipal").style.display = "grid";
  };

  function limparCamposInstalacao() {
    ["addNomeLocal", "addLocalDetalhe", "addPositivo", "addNegativo", "addPosChave", "addBloqueio", "addSaida2", "addEntrada1", "addEntrada2"].forEach(id => $(id).value = "");
  }
  
  // Fun√ß√£o para adaptar os campos de instala√ß√£o
  function handleTipoChange() {
    const isRastreador = $("addTipo").value === 'rastreador';
    $("localDetalheFields").style.display = isRastreador ? 'none' : 'block';
    $("addSubmodeloWrap").style.display = isRastreador ? 'none' : 'block'; 
    $("section2Title").innerHTML = isRastreador ? "2. Configura√ß√£o de Cabos Padr√£o" : "2. Adicionar Op√ß√£o de Instala√ß√£o";
    $("output1Label").innerText = isRastreador ? "Saida 1 (Bloqueio)" : "Bloqueio";
    $("trackerSpecificFields").style.display = isRastreador ? 'block' : 'none';
    preencherAddMarca();
  }
  $("addTipo").addEventListener("change", handleTipoChange);


  /* ================= L√ìGICA DE INSTALA√á√ïES (MODAL) ================= */
  
  window.adicionarInstalacaoNaLista = function() {
    const isRastreador = $("addTipo").value === 'rastreador';
    let nome = isRastreador ? `${$("addMarca").value} ${$("addModelo").value}`.trim() : $("addNomeLocal").value.trim();
    if(!nome || isRastreador && !$("addModelo").value.trim()) { 
        showNotification(isRastreador ? "Preencha o Modelo do rastreador (Se√ß√£o 1)." : "D√™ um nome para o local (ex: Painel).", "error"); 
        return; 
    }
    
    const novaInstalacao = {
      nomeLocal: nome,
      localDetalhe: isRastreador ? '' : $("addLocalDetalhe").value.trim(), 
      positivo: $("addPositivo").value.trim(),
      negativo: $("addNegativo").value.trim(),
      posChave: $("addPosChave").value.trim(),
      bloqueio: $("addBloqueio").value.trim(), 
    };

    if (isRastreador) {
        novaInstalacao.saida2 = $("addSaida2").value.trim();
        novaInstalacao.entrada1 = $("addEntrada1").value.trim();
        novaInstalacao.entrada2 = $("addEntrada2").value.trim();
    }

    tempInstalacoes.push(novaInstalacao);
    renderTempInstalacoes();
    limparCamposInstalacao();
    showNotification("Op√ß√£o de instala√ß√£o adicionada!", "success");
  };

  window.removerInstalacaoTemp = function(index) {
    tempInstalacoes.splice(index, 1);
    renderTempInstalacoes();
  };

  window.editarInstalacaoTemp = function(index) {
      const item = tempInstalacoes[index];
      // Adaptar para rastreador se for o caso
      if ($("addTipo").value === 'rastreador') {
          // No modo rastreador, o nomeLocal vem do Modelo+Marca, mas n√£o √© edit√°vel na se√ß√£o de cabos
          $("addNomeLocal").value = ''; 
          $("addLocalDetalhe").value = ''; 
      } else {
          $("addNomeLocal").value = item.nomeLocal || '';
          $("addLocalDetalhe").value = item.localDetalhe || '';
      }
      
      $("addPositivo").value = item.positivo || '';
      $("addNegativo").value = item.negativo || '';
      $("addPosChave").value = item.posChave || '';
      $("addBloqueio").value = item.bloqueio || '';

      if (item.saida2 || item.entrada1 || item.entrada2) {
          $("addSaida2").value = item.saida2 || '';
          $("addEntrada1").value = item.entrada1 || '';
          $("addEntrada2").value = item.entrada2 || '';
      } else {
          $("addSaida2").value = '';
          $("addEntrada1").value = '';
          $("addEntrada2").value = '';
      }
      
      tempInstalacoes.splice(index, 1);
      renderTempInstalacoes();
      showNotification("Dados carregados. Edite e clique em '+ Adicionar' novamente.", "info");
      if(!item.saida2 && !item.entrada1 && !item.entrada2) $("addNomeLocal").focus();
  };

  function renderTempInstalacoes() {
    const container = $("listaInstalacoesAdd");
    $("countInstalacoes").innerText = tempInstalacoes.length;
    
    if(tempInstalacoes.length === 0) {
      container.innerHTML = "<div style='text-align:center; color:var(--muted); font-size:13px;'>Nenhuma op√ß√£o adicionada ainda.</div>";
      return;
    }

    container.innerHTML = "";
    tempInstalacoes.forEach((inst, index) => {
      let div = document.createElement("div");
      div.className = "install-item";
      let details = inst.localDetalhe || "Sem detalhes";
      let title = inst.nomeLocal;
      
      if (inst.saida2 || inst.entrada1 || inst.entrada2) {
          details = `S2: ${inst.saida2 || '-'} | E1: ${inst.entrada1 || '-'} | E2: ${inst.entrada2 || '-'}`;
          title = "Modelo: " + title;
      } else {
          title = "Local: " + title;
      }

      div.innerHTML = `
        <div>
          <strong>${title}</strong>
          <span>${details}</span>
        </div>
        <div style="display:flex; gap:6px;">
            <button class='btn btn-sec' style="padding:4px 10px; font-size:12px;" onclick="editarInstalacaoTemp(${index})">Editar</button>
            <button class='btn btn-danger' style="padding:4px 10px; font-size:12px;" onclick="removerInstalacaoTemp(${index})">Excluir</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  /* ================= BUSCA R√ÅPIDA ================= */
  const mainInput = $("mainSearchInput");
  const suggestionsBox = $("mainSuggestions");

  mainInput.addEventListener("input", function() {
      const val = this.value.toLowerCase().trim();
      if(val.length < 2) { suggestionsBox.style.display = "none"; return; }

      const terms = val.split(" ");
      const matches = db.filter(v => {
          const str = `${v.tipo} ${v.marca} ${v.modelo} ${v.submodelo} ${v.ano}`.toLowerCase();
          return terms.every(t => str.includes(t));
      }).slice(0, 8); 

      if(matches.length === 0) {
           suggestionsBox.style.display = "none";
           return;
      }

      suggestionsBox.innerHTML = "";
      matches.forEach(v => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.innerHTML = `<strong>${v.modelo}</strong> <small>${v.marca} (${v.ano})</small>`;
          div.onclick = () => {
              mainInput.value = `${v.marca} ${v.modelo} ${v.ano}`;
              suggestionsBox.style.display = "none";
              exibirResultadoDireto(v);
          };
          suggestionsBox.appendChild(div);
      });
      suggestionsBox.style.display = "block";
  });

  document.addEventListener("click", (e) => {
      if(e.target !== mainInput) suggestionsBox.style.display = "none";
  });

  /* ================= BUSCA INTELIGENTE ================= */

  window.buscar = function() {
    let {tipoSelect,marcaSelect,modeloSelect,submodeloSelect,anoSelect} = ids();
    
    let r = db.find(v => v.tipo === tipoSelect.value && v.marca === marcaSelect.value && v.modelo === modeloSelect.value
      && (v.submodelo||"") === submodeloSelect.value && v.ano === anoSelect.value);
    
    if(!r) { $("resultado").innerHTML = "Nenhum padr√£o encontrado."; return; }
    exibirResultadoDireto(r);
  };

  function exibirResultadoDireto(r) {
      currentVehicleResult = r;
      $("seletorLocalWrap").style.display = "none";
      $("btnEditarResultado").style.display = "none";
      const isRastreador = r.tipo === 'rastreador';

      let instalacoes = r.instalacoes || [];
      
      if(instalacoes.length === 0 && r.local) {
          instalacoes.push({
            nomeLocal: "Padr√£o (√önico)",
            localDetalhe: r.local,
            positivo: r.positivo,
            negativo: r.negativo,
            posChave: r.posChave,
            bloqueio: r.bloqueio
          });
      }

      if(instalacoes.length === 0) {
          $("resultado").innerHTML = "Ve√≠culo cadastrado, mas sem dados de fia√ß√£o.";
      } else {
          const select = $("resultadoLocalSelect");
          select.innerHTML = "";
          $("seletorLocalTitle").innerText = isRastreador ? "Modelo: " : "Local de instala√ß√£o: ";

          instalacoes.forEach((inst, idx) => {
              let opt = document.createElement("option");
              opt.value = idx;
              let title;
              if (isRastreador) {
                  title = inst.nomeLocal; 
              } else {
                  title = inst.nomeLocal + (inst.localDetalhe ? ` - ${inst.localDetalhe}` : "");
              }
              opt.text = title;
              select.appendChild(opt);
          });

          $("seletorLocalWrap").style.display = "block";
          renderizarDetalhesInstalacao(instalacoes[0]);

          select.onchange = () => {
              renderizarDetalhesInstalacao(instalacoes[select.value]);
          };
      }

      const btnDiv = $("btnEditarResultado");
      if (loggedInUser) {
          btnDiv.style.display = "block";
          btnDiv.innerHTML = `<button class='btn btn-sec' onclick="editarVeiculo('${r.id}')">Editar </button>`;
      }
  }

  function renderizarDetalhesInstalacao(dados) {
      const isRastreador = currentVehicleResult && currentVehicleResult.tipo === 'rastreador';
      let mainLabel;
      let mainValue;
      let icon = isRastreador ? 'üì°' : 'üìç';

      if (isRastreador) {
          mainLabel = "Modelo do Rastreador";
          mainValue = dados.nomeLocal; 
      } else {
          mainLabel = "Local de Instala√ß√£o";
          mainValue = dados.nomeLocal + (dados.localDetalhe ? ` (${dados.localDetalhe})` : "");
      }
      
      const bloqueioLabel = isRastreador ? "Saida 1 (Bloqueio)" : "Bloqueio";
      const bloqueioClass = isRastreador ? "poschave-val" : "bloqueio-val"; 

      let html = `<div class="main-title-box">${icon} ${mainLabel}: **${mainValue}**</div>`;

      const renderWireItem = (label, value, valueClass = "") => {
          if (!value) return '';
          const displayValue = value.length > 30 ? value.substring(0, 30) + '...' : value;
          return `
              <div class="wire-item">
                  <span class="wire-label">${label}</span>
                  <span class="wire-value ${valueClass}">${displayValue}</span>
              </div>
          `;
      };

      html += renderWireItem(' Positivo ', dados.positivo, 'positivo-val');
      html += renderWireItem(' Negativo ', dados.negativo, 'negativo-val');
      html += renderWireItem(' P√≥s-chave ', dados.posChave, 'poschave-val');
      html += renderWireItem(` ${bloqueioLabel}`, dados.bloqueio, bloqueioClass);
      
      if (isRastreador) {
          html += '<div style="margin-top:10px; font-size:14px; font-weight:600; color:#0f766e; border-top: 1px solid #e2e8f0; padding-top: 10px;">Conex√µes Auxiliares (Opcional)</div>';
          html += renderWireItem(' Saida 2', dados.saida2);
          html += renderWireItem(' Entrada 1', dados.entrada1);
          html += renderWireItem(' Entrada 2', dados.entrada2);
      }
      
      $("resultado").innerHTML = html;
  }

  window.resetBusca = function() {
    ["tipoSelect","marcaSelect","modeloSelect","submodeloSelect","anoSelect"].forEach(id => $(id).value = "");
    ["marcaWrap","modeloWrap","subWrap","anoWrap"].forEach(id => $(id).style.display = "none");
    $("seletorLocalWrap").style.display = "none";
    $("btnEditarResultado").style.display = "none"; 
    $("mainSearchInput").value = "";
    $("resultado").innerHTML = "Sistema pronto. Fa√ßa sua busca.";
  };

  /* ================= SALVAR, EXCLUIR E EDITAR ================= */

 window.editarVeiculo = function(id) {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para EDITAR dados.", "error");
        return;
    }
    const v = userDB.find(x => x.id === id);
    if(!v) { showNotification('Ve√≠culo n√£o encontrado.','error'); return; }
    
    editarIndex = id;
    // NOVO: Armazena o estado anterior (deep copy para evitar modifica√ß√£o)
    oldVehicleData = JSON.parse(JSON.stringify(v)); 

    $("modalTitle").innerText = "Editar ve√≠culo ou rastreador";
    $("addTipo").value = v.tipo;
    handleTipoChange(); 
    $("addMarca").value = v.marca;
    $("addModelo").value = v.modelo;
    $("addSubmodelo").value = v.submodelo;
    $("addAno").value = v.ano;
    
    // Converte dados antigos para o novo formato de instala√ß√µes
    tempInstalacoes = v.instalacoes || [];
    
    if(tempInstalacoes.length === 0 && v.local) {
            tempInstalacoes.push({
                nomeLocal: "Instala√ß√£o Padr√£o",
                localDetalhe: v.local,
                positivo: v.positivo,
                negativo: v.negativo,
                posChave: v.posChave,
                bloqueio: v.bloqueio
            });
    }

    renderTempInstalacoes();
    limparCamposInstalacao();

    $("overlay").style.display = "block";
    $("modal").style.display = "block";
};

  window.removerVeiculo = async function(id) {
      if (!loggedInUser) {
          showNotification("Voc√™ precisa estar logado para EXCLUIR dados.", "error");
          return;
      }
      
      const veiculoParaExcluir = userDB.find(x => x.id === id);

      if(confirm(`Tem certeza que deseja EXCLUIR permanentemente: ${veiculoParaExcluir.marca} ${veiculoParaExcluir.modelo}?`)) {
          try {
              await deleteDoc(doc(dbFirestore, "veiculos", id));
              
              if (veiculoParaExcluir) {
                  // Opcional: Adiciona campos extras ao log para ter o ID
                  await registrarAcao("EXCLUSAO", { id: id, ...veiculoParaExcluir });
              }
              
              showNotification("Dados exclu√≠dos com sucesso.", "success");
              await carregarDadosDoFirebase();
          } catch(e) {
              console.error(e);
              showNotification("Erro ao excluir dados.", "error");
          }
      }
  };

  $("btnSalvar").onclick = async () => {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para SALVAR/EDITAR dados.", "error");
        fecharModal();
        return;
    }

    $("btnSalvar").innerText = "Salvando...";
    $("btnSalvar").disabled = true;

    if(tempInstalacoes.length === 0) {
        showNotification("Adicione pelo menos uma op√ß√£o de instala√ß√£o.", "error");
        $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
        $("btnSalvar").disabled = false;
        return;
    }
    
    const isRastreador = $("addTipo").value === 'rastreador';
    const submodeloValue = isRastreador ? "" : $("addSubmodelo").value.trim();

    const v = {
      tipo: $("addTipo").value,
      marca: $("addMarca").value,
      modelo: $("addModelo").value.trim(),
      submodelo: submodeloValue, 
      ano: $("addAno").value.trim(),
      instalacoes: tempInstalacoes
    };

    if(!v.tipo || !v.marca || !v.modelo || !v.ano) {
      showNotification("Preencha Tipo, Marca, Modelo e Ano.", "error");
      $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
      $("btnSalvar").disabled = false;
      return;
    }

    try {
      if (editarIndex) {
        await updateDoc(doc(dbFirestore, "veiculos", editarIndex), v);
        // NOVO: Passa o oldVehicleData para o hist√≥rico
        await registrarAcao("EDICAO", { id: editarIndex, ...v }, oldVehicleData); 
        showNotification("Dados atualizados!", "success");
      } else {
        const docRef = await addDoc(veiculosCollection, v);
        await registrarAcao("CADASTRO", { id: docRef.id, ...v });
        showNotification("Dados cadastrados!", "success");
      }
      await carregarDadosDoFirebase();
      fecharModal();
    } catch (e) {
      console.error("Erro ao salvar: ", e);
      showNotification("Erro ao salvar no servidor.", "error");
    } finally {
      $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
      $("btnSalvar").disabled = false;
      oldVehicleData = null; // Limpa o dado antigo ap√≥s salvar
    }
  };

  /* ================= FUN√á√ïES AUXILIARES DE OP√á√ïES/SELECT ================= */
  
  function addOpt(id,v){
    let o = document.createElement("option");
    o.value = v; o.text = v;
    $(id).appendChild(o);
  }
  
  function clearOptions(id, placeholder){
    const el = $(id); if(!el) return; el.innerHTML = "";
    let o = document.createElement('option'); o.value = ''; o.text = placeholder || '-- todos --';
    el.appendChild(o);
  }

  function resetCascata(ids){
    ids.forEach(n => { const el = $(n+"Select"); if(el) clearOptions(n+"Select", "-- selecione --"); });
  }

  function ids(){
    return {
      tipoSelect: $("tipoSelect"), marcaSelect: $("marcaSelect"),
      modeloSelect: $("modeloSelect"), submodeloSelect: $("submodeloSelect"), anoSelect: $("anoSelect")
    };
  }

  function preencherAddMarca(){
    const t = $("addTipo").value;
    clearOptions("addMarca", "-- selecione --");
    marcas[t].forEach(m=>addOpt("addMarca",m));
  }

  /* ================= CASCATA BUSCA PRINCIPAL ================= */
  
  $("tipoSelect").addEventListener("change",()=>{
    resetCascata(["marca","modelo","submodelo","ano"]);
    ["subWrap","modeloWrap","anoWrap"].forEach(id => $(id).style.display = "none");

    if($("tipoSelect").value){
      $("marcaWrap").style.display="block";
      clearOptions("marcaSelect", "-- selecione --");
      marcas[$("tipoSelect").value].forEach(m=>addOpt("marcaSelect",m));
    }
  });

  $("marcaSelect").addEventListener("change",()=>{
    const isRastreador = $("tipoSelect").value === 'rastreador';

    resetCascata(["modelo","submodelo","ano"]);

    let {tipoSelect,marcaSelect}=ids();
    let modelos=[...new Set(db.filter(v=>v.tipo===tipoSelect.value&&v.marca===marcaSelect.value).map(v=>v.modelo))];
    
    if(modelos.length){
      $("modeloWrap").style.display="block";
      clearOptions("modeloSelect", "-- selecione --");
      modelos.forEach(v=>addOpt("modeloSelect",v));
    }

    if(isRastreador) {
        $("subWrap").style.display = "none";
        if(modelos.length) { popularAnos(tipoSelect.value,marcaSelect.value,"",""); }
    } else {
        $("subWrap").style.display = "none"; 
    }
  });

  $("modeloSelect").addEventListener("change",()=>{
    const isRastreador = $("tipoSelect").value === 'rastreador';
    
    resetCascata(["submodelo","ano"]);
    let {tipoSelect,marcaSelect,modeloSelect}=ids();

    if(isRastreador) {
        $("subWrap").style.display="none";
        popularAnos(tipoSelect.value,marcaSelect.value,modeloSelect.value,"");

    } else {
        let subs=[...new Set(db.filter(v=>v.tipo===tipoSelect.value&&v.marca===marcaSelect.value&&v.modelo===modeloSelect.value).map(v=>v.submodelo).filter(s=>s))];
        
        if(subs.length){
            $("subWrap").style.display="block";
            clearOptions("submodeloSelect", "-- selecione --");
            subs.forEach(v=>addOpt("submodeloSelect",v));
        } else {
            $("subWrap").style.display="none";
            popularAnos(tipoSelect.value,marcaSelect.value,modeloSelect.value,"");
        }
    }
  });

  $("submodeloSelect").addEventListener("change",()=>{
    popularAnos($("tipoSelect").value,$("marcaSelect").value,$("modeloSelect").value,$("submodeloSelect").value);
  });

  function popularAnos(t,m,mo,s){
    resetCascata(["ano"]);
    $("anoWrap").style.display="block";
    
    const filteredDb = db.filter(v => 
        v.tipo === t && 
        v.marca === m && 
        v.modelo === mo &&
        (t === 'rastreador' || !s || v.submodelo === s) 
    );
    
    [...new Set(filteredDb.map(v=>v.ano))]
    .sort().forEach(a=>addOpt("anoSelect",a));
  }


  /* ================= FILTROS LISTA DE EDI√á√ÉO - L√ìGICA CORRIGIDA ================= */
  
  function popularFiltrosEdicao(data) {
    const tipo = $("editTipo").value;
    const marca = $("editMarca").value;
    const modelo = $("editModelo").value;

    // 1. Oculta Submodelo se for Rastreador
    $("editSubWrap").style.display = tipo === 'rastreador' ? 'none' : 'block';

    // 2. Popula Marca (baseado no Tipo)
    const currentMarca = $("editMarca").value;
    clearOptions("editMarca");
    const marcasUn = [...new Set(data.filter(v => !tipo || v.tipo === tipo).map(v => v.marca))].sort();
    marcasUn.forEach(v => addOpt('editMarca', v));
    $("editMarca").value = currentMarca; 
    
    // 3. Popula Modelo (baseado no Tipo e Marca)
    const currentModelo = $("editModelo").value;
    clearOptions("editModelo");
    const modelosUn = [...new Set(data.filter(v => 
        (!tipo || v.tipo === tipo) && 
        (!marca || v.marca === marca)
    ).map(v => v.modelo))].sort();
    modelosUn.forEach(v => addOpt('editModelo', v));
    $("editModelo").value = currentModelo;

    // 4. Popula Submodelo (baseado em Tipo, Marca e Modelo - exceto Rastreador)
    const currentSub = $("editSub").value;
    clearOptions("editSub");
    if (tipo !== 'rastreador') {
        const subsUn = [...new Set(data.filter(v =>
            v.submodelo && 
            (!tipo || v.tipo === tipo) && 
            (!marca || v.marca === marca) &&
            (!modelo || v.modelo === modelo)
        ).map(v => v.submodelo))].sort();
        subsUn.forEach(v => addOpt('editSub', v));
    }
    $("editSub").value = currentSub;

    // 5. Popula Ano (baseado em todos os filtros anteriores)
    popularAnosEdicao();
  }

  function popularAnosEdicao() {
    const tipo = $("editTipo").value;
    const marca = $("editMarca").value;
    const modelo = $("editModelo").value;
    const sub = $("editSub").value;
    const currentAno = $("editAno").value;

    clearOptions("editAno");

    const anosUn = [...new Set(userDB.filter(v => 
        (!tipo || v.tipo === tipo) &&
        (!marca || v.marca === marca) &&
        (!modelo || v.modelo === modelo) &&
        (tipo === 'rastreador' || !sub || v.submodelo === sub) 
    ).map(v => v.ano))].sort();

    anosUn.forEach(v => addOpt('editAno', v));
    $("editAno").value = currentAno;
  }
  
  window.filtrarEdicao = function() {
    const termo = $("editSearchInput").value.toLowerCase().trim();
    const tipo = $("editTipo").value;
    const marca = $("editMarca").value;
    const modelo = $("editModelo").value;
    const sub = $("editSub").value;
    const ano = $("editAno").value;
    
    let lista = userDB.filter(v => {
      const fullString = `${v.marca} ${v.modelo} ${v.submodelo} ${v.ano}`.toLowerCase();
      const matchTexto = !termo || termo.split(" ").every(t => fullString.includes(t));

      const matchTipo = !tipo || v.tipo === tipo;
      const matchMarca = !marca || v.marca === marca;
      const matchModelo = !modelo || v.modelo === modelo;
      const matchSub = !sub || v.submodelo === sub;
      const matchAno = !ano || v.ano === ano;

      return matchTexto && matchTipo && matchMarca && matchModelo && matchSub && matchAno;
    });

    renderLista(lista);
  };

  // Listeners de filtro para atualizar a cascata E filtrar a lista.
  $("editTipo").onchange = () => { 
      clearOptions("editMarca"); clearOptions("editModelo"); clearOptions("editSub"); clearOptions("editAno");
      popularFiltrosEdicao(userDB); 
      filtrarEdicao(); 
  }; 
  
  $("editMarca").onchange = () => { 
      clearOptions("editModelo"); clearOptions("editSub"); clearOptions("editAno");
      popularFiltrosEdicao(userDB); 
      filtrarEdicao(); 
  };
  
  $("editModelo").onchange = () => { 
      clearOptions("editSub"); clearOptions("editAno");
      popularFiltrosEdicao(userDB); 
      filtrarEdicao(); 
  };
  
  $("editSub").onchange = () => { 
      popularAnosEdicao(); 
      filtrarEdicao(); 
  }; 
  
  $("editAno").onchange = filtrarEdicao; 

  /* ================= LISTAGEM E RENDERIZA√á√ÉO ================= */
  
  function renderLista(lista=null){
    lista = lista || userDB;
    let c = $("listaVeiculos"); c.innerHTML = "";
    if(!lista.length){ c.innerHTML = "<i>Nenhum ve√≠culo encontrado</i>"; return; }
    lista.forEach((v) => {
      let d = document.createElement("div");
      d.style = "padding:10px 0;border-bottom:1px solid #ddd;";
      let qtdOpcoes = v.instalacoes ? v.instalacoes.length : 1;
      
      d.innerHTML = `
      <div style='display:flex;align-items:center;justify-content:space-between'>
        <div>
           <strong>${v.marca} ${v.modelo}</strong> (${v.ano})<br>
           <span style="font-size:12px;color:#666">${qtdOpcoes} local(is) ${v.submodelo && v.tipo !== 'rastreador' ? '| '+v.submodelo : ''}</span>
        </div>
        <div style="display:flex; gap:8px;">
            <button class='btn btn-sec' onclick="editarVeiculo('${v.id}')">Editar</button>
            <button class='btn btn-danger' onclick="removerVeiculo('${v.id}')">Excluir</button>
        </div>
      </div>`;
      c.appendChild(d);
    });
  }
</script>
</body>
</html>
