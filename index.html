<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fio Certo</title>
<style>
:root{
  --bg:#f3f6fb; --card:#ffffff; --muted:#6b7280; --accent:#0ea5a3; --accent-darker:#0b8f8c;
  --btn:#0369a1; --success:#10b981; --danger:#ef4444; --radius:12px; --glass: rgba(255,255,255,0.7);}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#e6eef7,var(--bg));color:#0f172a;}
.container{max-width:980px;margin:28px auto;padding:20px;}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;}
.title{display:flex;gap:12px;align-items:center;}
.logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-darker));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;}
h1{font-size:20px;margin:0} .subtitle{color:var(--muted);font-size:13px;}
.grid{display:grid;grid-template-columns: 1fr 420px;gap:18px;}
.card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow: 0 6px 20px rgba(15,23,42,0.06);}
label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
select,input{width:100%;padding:10px 12px;margin-top:6px;border-radius:10px;border:1px solid #e6eef7;background:var(--glass);font-size:14px;}
.row{display:flex;gap:10px;align-items:center;margin-top:12px}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;}
.btn-primary{background:var(--btn);color:white;box-shadow:0 8px 18px rgba(3,105,161,0.12)}
.btn-primary:hover{background:#054b73}
.btn-sec{background:#fff;border:1px solid #e6eef7}
.btn-green{background:var(--success);color:white}
.btn-danger{background:var(--danger);color:white}
.small{font-size:13px;color:var(--muted);}
.resultTitle{font-weight:700;margin:0 0 6px 0}

/* --- Estilo para o Aviso de Limpeza --- */
.info-alert {
    margin-top: 20px;
    padding: 12px;
    background: #fffaeb; /* Amarelo muito claro */
    border: 1px solid #fcd34d; /* Amarelo m√©dio */
    color: #b45309; /* Marrom escuro */
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
}
/* NOVO ESTILO PARA O RESULTADO */
.resultBox {
    background: var(--card); 
    padding: 18px; /* Aumentei um pouco o padding */
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08); 
    font-family: Inter, sans-serif; 
    color: #0f172a; 
    min-height: 250px; /* Garante que a caixa tenha um tamanho m√≠nimo */
}
/* Novo estilo para cada item de fia√ß√£o */
.wire-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0; /* Aumentei o espa√ßamento */
    border-bottom: 1px dashed #e2e8f0;
}
.wire-item:last-child {
    border-bottom: none;
}
.wire-label {
    font-size: 16px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}
.wire-value {
    font-size: 16px;
    font-weight: 700;
    color: #0f172a; 
}
/* Cores de destaque */
.positivo-val { color: #000000; } 
.negativo-val { color: #000000; } 
.poschave-val { color: #000000; } 
.bloqueio-val { color: #000000; } 

/* T√≠tulo principal do Ve√≠culo/Local */
.main-title-box {
    background: #eff6ff;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 700;
    color: #1e40af;
}

/* ESTILOS DO HIST√ìRICO EXPANDIDO */
.history-details {
    display: none; /* Oculto por padr√£o */
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin-top: 8px;
    font-size: 13px;
    color: #334155;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
}
.history-details p { margin: 4px 0; }
.history-wire-group {
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f1f5f9;
}
.history-wire-group:last-child { border-bottom: none; }

/* Adicionado para compara√ß√£o no hist√≥rico */
.comparison-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 10px;
}
.comparison-box {
    border: 1px solid #e6eef7;
    background: #fdfdfd;
    padding: 10px;
    border-radius: 8px;
}
.comparison-box h4 {
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 14px;
    color: #4a5568;
    border-bottom: 1px dashed #e2e8f0;
    padding-bottom: 5px;
}
.changed-field {
    color: #c52438; /* Cor para indicar mudan√ßa */
    font-weight: 600;
    background-color: #ffeaea;
    padding: 1px 3px;
    border-radius: 3px;
}
.history-install-item {
    background: #f1f5f9;
    padding: 6px;
    border-radius: 6px;
    margin-top: 4px;
    font-size: 12px;
    margin-bottom: 6px;
}
.history-install-item strong { color: #334155; }
.history-install-item span { color: #64748b; }

/* NOVO: Estilo para o box de filtros do hist√≥rico */
#historicoModal > div:nth-child(3) {
    background: #f1f5f9; 
    padding: 12px; 
    border-radius: 8px; 
    margin-bottom: 15px;
}

/* MODAL & OVERLAY */
#overlay{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:60}
#modal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:500px;max-width:94%;z-index:70;border-radius:12px;padding:18px;background:var(--card);box-shadow:0 20px 60px rgba(2,6,23,0.25);max-height:90vh;overflow:auto}

/* Estilos para Modais de Senha/Auth/Hist√≥rico */
#historicoPasswordModal, #modalAlterarSenha {
    display: none; 
    position: fixed; 
    left: 50%; 
    top: 50%; 
    transform: translate(-50%,-50%); 
    width: 350px; 
    max-width: 94%; 
    z-index: 80; 
    border-radius: 12px; 
    padding: 18px; 
    background: var(--card); 
    box-shadow: 0 20px 60px rgba(2,6,23,0.25); 
}
#historicoModalOverlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.45);
    z-index: 60;
}
#historicoModal{
    display:none;
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:700px;
    max-width:94%;
    z-index:70;
    border-radius:12px;
    padding:18px;
    background:var(--card);
    box-shadow:0 20px 60px rgba(2,6,23,0.25);
    max-height:90vh;
    overflow:auto
}


.modalHeader{display:flex;justify-content:space-between;align-items:center; margin-bottom: 10px;}
.modalClose{background:transparent;border:none;color:var(--muted);font-weight:700;cursor:pointer}
.note{font-size:13px;color:var(--muted);margin-top:6px}

/* INSTALA√á√ïES NO MODAL */
.install-list { margin-top: 15px; border-top: 1px solid #e6eef7; padding-top: 10px; }
.install-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.install-item strong { display: block; font-size: 14px; color: #334155; }
.install-item span { font-size: 12px; color: #64748b; }
.section-title { font-size: 14px; font-weight: 700; color: var(--accent-darker); margin-top: 20px; border-bottom: 2px solid #e6eef7; padding-bottom: 5px; margin-bottom: 10px; }

/* TOAST NOTIFICATIONS */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; display: flex; align-items: center; animation: slideIn 0.3s ease; min-width: 250px;}
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.info { background: var(--btn); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* AUTOCOMPLETE SUGGESTIONS */
.suggestions-box { position: absolute; background: white; width: 100%; border: 1px solid #e2e8f0; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 50; margin-top: 2px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
.suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
.suggestion-item:hover { background: #f1f5f9; }
.relative { position: relative; }

/* OR SEPARATOR STYLE */
.separator-box { margin: 15px 0; border-bottom: 1px solid #e6eef7; position: relative; text-align: center; }
.separator-text { background: white; padding: 0 10px; color: #999; font-size: 12px; position: relative; top: 8px; }

/* FOOTER NOTICE */
.footer-notice {
    max-width: 980px;
    margin: 20px auto 30px auto;
    padding: 15px;
    text-align: center;
    font-size: 14px;
    color: var(--muted);
    background: #e6eef7; /* Fundo azul/cinza claro */
    border-radius: 10px;
    border: 1px solid #c9dff7;
}
.footer-notice a {
    color: var(--btn);
    font-weight: 600;
    text-decoration: none;
}

/* NOVO: Estilo para o Dropdown Menu */
.dropdown-menu-container {
    position: relative;
    display: inline-block;
}
.menu-toggle-btn {
    /* Novo bot√£o para abrir o menu */
    padding: 10px 14px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: #ffffff; /* Fundo branco ou neutro */
    border: 1px solid #e6eef7;
    color: var(--btn);
}
.dropdown-menu {
    position: absolute;
    top: 100%; /* Abaixo do bot√£o */
    right: 0;
    background: var(--card);
    border: 1px solid #e6eef7;
    border-radius: var(--radius);
    box-shadow: 0 8px 16px rgba(15,23,42,0.1);
    min-width: 200px;
    z-index: 100;
    margin-top: 8px; /* Espa√ßo entre o bot√£o e o menu */
    display: none; /* Oculto por padr√£o */
    padding: 8px 0;
}
.dropdown-menu button {
    display: block;
    width: 100%;
    padding: 10px 15px;
    text-align: left;
    background: transparent;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: #334155;
    font-size: 14px;
}
.dropdown-menu button:hover {
    background: #f1f5f9;
}
.dropdown-menu .separator {
    height: 1px;
    background: #e6eef7;
    margin: 8px 0;
}


@media (max-width:900px){.grid{grid-template-columns:1fr; }.title h1{font-size:18px}}
</style>
</head>
<body>

<div id="toast-container" class="toast-container"></div>

<div class="container">

  <div class="header">
    <div class="title">
      <div class="logo">FC</div>
      <div>
        <h1>Fio Certo</h1>
        <div class="subtitle">Padr√µes de cores e locais para instala√ß√£o de rastreadores (Online)</div>
      </div>
    </div>
    <div style="display:flex; gap: 12px; align-items: center;">
      
      <button class="btn btn-primary" id="loginRegisterButton" onclick="abrirModalAuth()">Login / Cadastrar</button>
      
      <div class="dropdown-menu-container" id="menuDropdownContainer" style="display:none;">
          
          <button class="menu-toggle-btn" onclick="toggleMenu()">Menu ‚ñº</button>
          
          <div class="dropdown-menu" id="userMenuDropdown">
              <button id="btnCadastrarVeiculoMenu" onclick="abrirCadastro(); toggleMenu();">‚ûï Cadastrar Ve√≠culo/Rastreador</button>
              
              <button id="editButtonMenu" onclick="abrirEditar(); toggleMenu();">üìù Editar Ve√≠culo/Rastreador</button>
              
              <button id="historicoButtonMenu" onclick="abrirHistorico(); toggleMenu();">‚è≥ Hist√≥rico de altera√ß√µes</button>
              
              <div class="separator"></div>

              <button id="alterarSenhaButtonMenu" onclick="abrirModalAlterarSenha(); toggleMenu();">üîë Alterar Senha</button>
              
              <button id="logoutButtonMenu" onclick="fazerLogout(); toggleMenu();">üö™ Logout</button>
              
          </div>
      </div>
      
    </div>
  </div>

  <div class="grid" id="gridPrincipal">
    <div class="card">
        
      <label style="color:var(--accent-darker); font-weight:700">üîç Busca R√°pida</label>
      <div class="relative">
          <input id="mainSearchInput" placeholder="Digite ex: Uno Way 2020..." autocomplete="off">
          <div id="mainSuggestions" class="suggestions-box"></div>
      </div>

      <div class="separator-box">
          <span class="separator-text">OU FILTRE ABAIXO</span>
      </div>

      <label>Tipo do ve√≠culo ou rastreador</label>
      <select id="tipoSelect">
        <option value="">-- selecione --</option>
        <option value="carro">Carro</option>
        <option value="moto">Moto</option>
        <option value="caminhao">Caminh√£o</option>
        <option value="rastreador">Rastreador</option>
      </select>

      <div id="marcaWrap" style="display:none">
        <label>Marca</label>
        <select id="marcaSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="modeloWrap" style="display:none">
        <label>Modelo</label>
        <select id="modeloSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="subWrap" style="display:none">
        <label>Submodelo</label>
        <select id="submodeloSelect"><option value="">-- selecione --</option></select>
      </div>

      <div id="anoWrap" style="display:none">
        <label>Ano</label>
        <select id="anoSelect"><option value="">-- selecione --</option></select>
      </div>

      <div class="row" style="margin-top:16px">
        <button class="btn btn-primary" onclick="buscar()">Buscar</button>
        <button class="btn btn-sec" onclick="resetBusca()">Limpar</button>
      </div>
      
      <div class="info-alert">
          üí°  Aviso: Sempre que for fazer uma nova busca ou usar o filtro, aperte no bot√£o "Limpar".
      </div>
      
    </div>

    <div class="card">
      <h3 class="resultTitle">Resultado</h3>
      
      <div id="seletorLocalWrap" style="display:none; margin-bottom: 15px; padding: 10px; background: #eff6ff; border-radius: 8px;">
        <label id="seletorLocalTitle" style="color: #1e3a8a; font-weight: bold; margin-top:0;">Op√ß√£o de Local de Instala√ß√£o:</label>
        <select id="resultadoLocalSelect" style="background: white; border: 1px solid #bfdbfe; color: #1e3a8a; font-weight: 600;">
        </select>
      </div>

      <div id="resultado" class="resultBox">Sistema pronto. Fa√ßa sua busca.</div>
      
      <div id="btnEditarResultado" style="margin-top:10px;text-align:right;display:none">
         </div>
    </div>
  </div>

  <div id="editarAba" style="display:none;">
    <div class="card">
      <div class="row" style="justify-content:flex-end;margin-bottom:8px;">
        <button class="btn btn-sec" onclick="voltarBusca()">Voltar √† Busca</button>
      </div>
      
      <h3>Gerenciar Ve√≠culos e Rastreadores</h3>

      <label style="color:var(--accent-darker); font-weight:700">üîç Busca R√°pida (Lista)</label>
      <input id="editSearchInput" placeholder="Digite ex: Honda Civic 2020..." onkeyup="filtrarEdicao()">

      <div class="separator-box">
          <span class="separator-text">OU FILTRE ABAIXO</span>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px">
          <div>
            <label>Tipo</label>
            <select id="editTipo" style="margin-top:0">
              <option value="">-- todos --</option>
              <option value="carro">Carro</option>
              <option value="moto">Moto</option>
              <option value="caminhao">Caminh√£o</option>
              <option value="rastreador">Rastreador</option>
            </select>
          </div>
          <div>
              <label>Marca</label>
              <select id="editMarca" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div>
              <label>Modelo</label>
              <select id="editModelo" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div id="editSubWrap">
              <label>Submodelo</label>
              <select id="editSub" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
          <div>
              <label>Ano</label>
              <select id="editAno" style="margin-top:0"><option value="">-- todos --</option></select>
          </div>
      </div>

      <div id="listaVeiculos" style="margin-top:12px;"></div>
    </div>
  </div>

</div> <div class="footer-notice">
    Para o cadastro e edi√ß√£o dos ve√≠culos ou rastreadores, entre em contato com o email: 
    <a href="mailto:fiocertorastreadores@gmail.com">fiocertorastreadores@gmail.com</a>
</div>

<div id="overlay"></div>

<div id="modal">
  <div class="modalHeader">
    <strong id="modalTitle">Cadastrar ve√≠culo</strong>
    <button class="modalClose" onclick="fecharModal()">X</button>
  </div>
  <p class="note">Preencha os dados do ve√≠culo ou rastreador e adicione as op√ß√µes de instala√ß√£o.</p>

  <div class="section-title">1. Dados do Ve√≠culo ou Rastreador</div>
  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
      <div>
        <label>Tipo</label>
        <select id="addTipo">
          <option value="carro">Carro</option>
          <option value="moto">Moto</option>
          <option value="caminhao">Caminh√£o</option>
          <option value="rastreador">Rastreador</option>
        </select>
      </div>
      <div><label>Marca</label><select id="addMarca"></select></div>
  </div>
  <label>Modelo</label><input id="addModelo" placeholder="Ex: Uno, Onix, CG, Biz">
  <div id="vehicleDetailsGrid" class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
    <div id="addSubmodeloWrap">
        <label>Submodelo</label><input id="addSubmodelo" placeholder="Ex: Way 1.3, Joy, LTZ, Fan 125, Titan 160">
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div><label>Ano (ou In√≠cio)</label><input id="addAno" type="number" placeholder="Ex: 2015"></div>
        <div><label>Ano Final (Opcional)</label><input id="addAnoFinal" type="number" placeholder="Ex: 2020"></div>
    </div>
  </div>

  <div class="section-title" id="section2Title">2. Adicionar Op√ß√£o de Instala√ß√£o</div>
  <div style="background: #f1f5f9; padding: 12px; border-radius: 8px;">
      
      <div id="localDetalheFields">
          <label style="color:#0f172a; font-weight:700">Nome do Local (Ex: Caixa de Fus√≠veis)</label>
          <input id="addNomeLocal" placeholder="Ex: Painel, Caixa de Fus√≠veis, Airbag...">
          
          <label>Local Detalhado (Opcional)</label>
          <input id="addLocalDetalhe" placeholder="Ex: Abaixo do volante, fio grosso">
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
        <div><label>Positivo</label><input id="addPositivo"></div>
        <div><div><label>Negativo</label><input id="addNegativo"></div></div>
      </div>
      
      <div id="wireConnectionsGrid" class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
        <div><label id="labelPosChave">P√≥s-chave</label><input id="addPosChave"></div>
        <div><label id="labelBloqueio">Bloqueio</label><input id="addBloqueio"></div>
      </div>

      <div id="auxConnectionsGrid" class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e6eef7; display:none;">
          <div><label id="labelSaida2">Saida 2</label><input id="addSaida2"></div>
          <div><label id="labelEntrada2">Entrada 2</label><input id="addEntrada2"></div>
      </div>


      <button class="btn btn-sec" style="width:100%; margin-top:10px; border-color:var(--accent); color:var(--accent-darker)" onclick="adicionarInstalacaoNaLista()">+ Adicionar esta Op√ß√£o</button>
  </div>

  <div class="section-title">Op√ß√µes Adicionadas (<span id="countInstalacoes">0</span>)</div>
  <div id="listaInstalacoesAdd" class="install-list">
      <div style="text-align:center; color:var(--muted); font-size:13px;">Nenhuma op√ß√£o adicionada ainda.</div>
  </div>

  <div class="row" style="justify-content:flex-end;margin-top:14px; border-top: 2px solid #ddd; padding-top:10px;">
    <button class="btn btn-sec" onclick="fecharModal()">Cancelar</button>
    <button class="btn btn-green" id="btnSalvar" onclick="salvarVeiculo()">Salvar Ve√≠culo ou Rastreador Completo</button>
  </div>
</div>
<div id="historicoPasswordModal">
    <div class="modalHeader">
      <strong>Acesso Restrito ao Hist√≥rico</strong>
      <button class="modalClose" onclick="fecharHistoricoPasswordModal()">X</button>
    </div>
    <p class="note">Insira o c√≥digo secreto para visualizar o Hist√≥rico de altera√ß√µes.</p>
    
    <label>C√≥digo Secreto</label>
    <input id="historicoSenhaInput" type="password" placeholder="Seu c√≥digo secreto (N√£o √© a senha de login)">
    
    <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="verificarSenhaHistorico()">Acessar Hist√≥rico</button>
</div>
<div id="modalAlterarSenha">
  <div class="modalHeader">
    <strong>Alterar Senha de Login</strong>
    <button class="modalClose" onclick="fecharModalAlterarSenha()">X</button>
  </div>
  <p class="note">Mude sua senha de **Login** no sistema.</p>
  
  <label>Senha Atual</label>
  <input id="currentPasswordInput" type="password" placeholder="Sua senha atual">

  <label style="margin-top:15px;">Nova Senha</label>
  <input id="newPasswordInput" type="password" placeholder="M√≠nimo 6 caracteres">
  
  <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="alterarSenha()">Confirmar Altera√ß√£o</button>
</div>
<div id="historicoModalOverlay"></div>
<div id="historicoModal">
  <div class="modalHeader">
    <strong>Hist√≥rico de A√ß√µes</strong>
    <button class="modalClose" onclick="fecharHistoricoModal()">X</button>
  </div>
  <p class="note">Registro de cadastros, edi√ß√µes e exclus√µes no banco de dados. Filtros aplicados sobre todos os itens carregados.</p>
  
  <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
    <label style="color:var(--accent-darker); font-weight:700">üîç Buscar por Ve√≠culo/Detalhe</label>
    <input id="historySearchInput" placeholder="Ex: Uno Way 2020 ou fio amarelo" onkeyup="filtrarHistorico()">

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px">
      <div>
        <label>Tipo de A√ß√£o</label>
        <select id="historyTipoSelect" onchange="filtrarHistorico()" style="margin-top:0">
          <option value="">-- todos --</option>
          <option value="CADASTRO">Cadastro</option>
          <option value="EDICAO">Edi√ß√£o</option>
          <option value="EXCLUSAO">Exclus√£o</option>
        </select>
      </div>
      <div>
        <label>Usu√°rio</label>
        <select id="historyUserSelect" onchange="filtrarHistorico()" style="margin-top:0">
          <option value="">-- todos --</option>
        </select>
      </div>
      
      <div>
        <label>Data (A partir de)</label>
        <input id="historyDateStart" type="date" onchange="filtrarHistorico()" style="margin-top:0">
      </div>
      <div>
        <label>Data (At√©)</label>
        <input id="historyDateEnd" type="date" onchange="filtrarHistorico()" style="margin-top:0">
      </div>
      
    </div>
  </div>
  <div id="historicoLista">Carregando hist√≥rico...</div>
  
  <div style="text-align:center; margin-top: 15px;">
    <button class="btn btn-sec" id="btnCarregarMaisHistorico" onclick="fetchHistoryBatch(false)" style="display:none; width: 100%;">Carregar Mais 50 Registros Antigos</button>
  </div>
  <p id="historyEndMessage" class="small" style="text-align:center; margin-top: 10px; color:var(--success); display:none;">Fim do Hist√≥rico Carregado</p>

</div>
<div id="modalAuth" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:350px; max-width:94%; z-index:80; border-radius:12px; padding:18px; background:var(--card); box-shadow:0 20px 60px rgba(2,6,23,0.25); max-height:90vh; overflow:auto">
  <div class="modalHeader">
    <strong id="authModalTitle">Login / Cadastro</strong>
    <button class="modalClose" onclick="fecharModalAuth()">X</button>
  </div>
  
  <label>Email</label>
  <input id="authEmail" type="email" placeholder="seu.email@exemplo.com">

  <label>Senha</label>
  <input id="authSenha" type="password" placeholder="M√≠nimo 6 caracteres">
  
  <label style="margin-top:15px; color:var(--danger)">C√≥digo de Cadastro (Obrigat√≥rio para Criar Conta)</label>
  <input id="authCode" type="text" placeholder="Solicite o c√≥digo secreto">

  <div class="row" style="margin-top:20px; justify-content:space-between">
    <button class="btn btn-primary" id="btnLogin" onclick="handleLogin()">Login</button>
    <button class="btn btn-sec" id="btnRegister" onclick="handleRegister()">Cadastrar</button>
  </div>
</div>
<script type="module">
  /* ================= FIREBASE SETUP ================= */
  // CORRE√á√ÉO ESSENCIAL: Adicionando importa√ß√£o de initializeApp
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
  // IMPORT ATUALIZADO: Adicionando 'startAfter' para pagina√ß√£o
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB097Hr3Vg55djiCjW8A3m_vhK4Jen-Xlw",
    authDomain: "fiocertorastreador.firebaseapp.com",
    projectId: "fiocertorastreador",
    storageBucket: "fiocertorastreador.firebasestorage.app",
    messagingSenderId: "735489114974",
    appId: "1:735489114974:web:40820bcec28e2b252fc5cf",
    measurementId: "G-2P8HSDLBLZ"
  };

  const app = initializeApp(firebaseConfig);
  const dbFirestore = getFirestore(app);
  const veiculosCollection = collection(dbFirestore, "veiculos");
  const historicoAcoesCollection = collection(dbFirestore, "historico_acoes"); 
  const auth = getAuth(app);

  /* ================= VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ÉO DE SENHA SECRETA ================= */
  let userDB = []; 
  let loggedInUser = null; 
  let db = [];
  let editarIndex = null;
  let oldVehicleData = null; 
  let tempInstalacoes = [];
  let currentVehicleResult = null;
  let historyData = []; // Armazena o hist√≥rico completo carregado (agora com pagina√ß√£o)

  // NOVO: Vari√°veis de controle para Pagina√ß√£o do Hist√≥rico
  const HISTORY_BATCH_SIZE = 50; 
  let lastVisibleHistoryDoc = null; 
  let hasMoreHistory = true; 
  let isLoadingHistory = false; // Para evitar m√∫ltiplos cliques de "Carregar Mais"

  
  // =========================================================================
  // !!! ATEN√á√ÉO: SENHA SECRETA DO HIST√ìRICO !!!
  // Mude este valor para o c√≥digo que s√≥ voc√™ saber√°.
  const HISTORY_SECRET_CODE = "112512"; 
  // =========================================================================

  const marcas = {
    carro:["Fiat","Volkswagen","Chevrolet","Toyota","Ford","Renault","Peugeot","Citro√´n","Honda","Hyundai","Land Rover","Ram","BYD"],
    moto:["Honda","Yamaha","Suzuki","BMW","Shineray","Dafra","Kawasaki"],
    caminhao:["Volvo","Scania","Mercedes-Benz","Volkswagen Caminh√µes","Iveco","Ford","Renault Trucks","Hyundai HR / Kia Bongo"],
    rastreador:["Suntech", "Ituran", "Positron", "Cobli", "Tracker Brasil", "X3Tech"]
  };

  const $ = id => document.getElementById(id);

  /* ================= NOTIFICATION SYSTEM (TOAST) ================= */
  window.showNotification = function(message, type = 'info') {
      const container = $("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      
      let icon = '';
      if(type === 'success') icon = '‚úÖ ';
      if(type === 'error') icon = '‚ùå ';
      if(type === 'info') icon = '‚ÑπÔ∏è ';

      toast.innerHTML = `<span>${icon} ${message}</span>`;
      container.appendChild(toast);

      setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          toast.style.transition = 'all 0.3s ease';
          setTimeout(() => toast.remove(), 300);
      }, 3500);
  };
  
  /* ================= MODAL AUTH FUNCTIONS ================= */
  
  window.abrirModalAuth = function() {
    $("overlay").style.display = "block";
    $("modalAuth").style.display = "block";
  };

  window.fecharModalAuth = function() {
    $("overlay").style.display = "none";
    $("modalAuth").style.display = "none";
    $("authEmail").value = "";
    $("authSenha").value = "";
    $("authCode").value = ""; 
  };

  /* ================= FIREBASE AUTH FUNCTIONS ================= */
  
  const SECRET_CODE = "fiocerto2025"; 

  window.handleRegister = function() {
    const email = $("authEmail").value;
    const senha = $("authSenha").value;
    const code = $("authCode").value.trim(); 

    if (code !== SECRET_CODE) {
        showNotification('C√≥digo de Cadastro incorreto. Solicite o c√≥digo.', 'error');
        return;
    }

    createUserWithEmailAndPassword(auth, email, senha)
      .then(() => {
        showNotification('Cadastro realizado e Login efetuado!', 'success');
        fecharModalAuth();
      })
      .catch((error) => {
        console.error(error);
        showNotification('Erro no cadastro: ' + error.message.replace("Firebase: ", ""), 'error');
      });
  };

  window.handleLogin = function() {
    const email = $("authEmail").value;
    const senha = $("authSenha").value;

    signInWithEmailAndPassword(auth, email, senha)
      .then(() => {
        showNotification('Login realizado com sucesso!', 'success');
        fecharModalAuth();
      })
      .catch((error) => {
        console.error(error);
        showNotification('Erro no login: ' + error.message.replace("Firebase: ", ""), 'error');
      });
  };

  window.fazerLogout = function() {
    signOut(auth).then(() => {
        showNotification("Voc√™ foi desconectado.", "info");
    }).catch((error) => {
        console.error("Erro ao fazer logout:", error);
        showNotification("Erro ao fazer logout.", "error");
    });
  };

  function updateUIAuth(user) {
    const loggedOutElements = document.querySelectorAll('#loginRegisterButton');
    const loggedInElements = document.querySelectorAll('#menuDropdownContainer');
    
    loggedOutElements.forEach(el => el.style.display = user ? 'none' : 'block');
    loggedInElements.forEach(el => el.style.display = user ? 'block' : 'none');

    // Se estiver logado e na aba de edi√ß√£o, atualiza a lista
    if (user) {
        if ($("editarAba").style.display === "block") {
            // Inicializa todos os filtros corretamente
            popularMarcasEdit();
            popularModelosEdit();
            popularSubsEdit();
            popularAnosEdit();
            renderLista();
        }
    } else {
        // Se deslogou, volta para a busca
        $("editarAba").style.display = "none";
        $("gridPrincipal").style.display = "grid";
        $("resultado").innerHTML = "Sistema pronto. Fa√ßa sua busca.";
    }
  }

  /* ================= DROP-DOWN MENU ACTIONS ================= */
  
  window.toggleMenu = function() {
    const menu = $("userMenuDropdown");
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  };
  
  // Fecha o menu se clicar fora
  document.addEventListener('click', function(event) {
    const container = $("menuDropdownContainer");
    const menu = $("userMenuDropdown");
    const toggleButton = document.querySelector('.menu-toggle-btn');
    
    if (container.style.display === 'block' && menu.style.display === 'block' && event.target !== container && !container.contains(event.target)) {
        // Verifica se o clique n√£o foi no pr√≥prio bot√£o toggle
        if (event.target !== toggleButton) {
            menu.style.display = 'none';
        }
    }
  });

  /* ================= ALTERAR SENHA FIREBASE (LOGIN) ================= */
  window.abrirModalAlterarSenha = function() {
    if (!loggedInUser) {
        showNotification("Fa√ßa login para alterar a senha.", "error");
        return;
    }
    $("historicoModalOverlay").style.display = "block";
    $("modalAlterarSenha").style.display = "block";
    $("currentPasswordInput").value = "";
    $("newPasswordInput").value = "";
    $("currentPasswordInput").focus();
  };

  window.fecharModalAlterarSenha = function() {
    $("historicoModalOverlay").style.display = "none";
    $("modalAlterarSenha").style.display = "none";
  };

  window.alterarSenha = async function() {
    const senhaAtual = $("currentPasswordInput").value;
    const novaSenha = $("newPasswordInput").value;

    if (!senhaAtual || !novaSenha) {
        showNotification("Preencha todos os campos.", "error");
        return;
    }

    if (novaSenha.length < 6) {
        showNotification("A nova senha deve ter no m√≠nimo 6 caracteres.", "error");
        return;
    }
    
    if (senhaAtual === novaSenha) {
        showNotification("A nova senha deve ser diferente da atual.", "error");
        return;
    }

    const btn = document.querySelector("#modalAlterarSenha .btn-primary");
    btn.innerText = "Verificando...";
    btn.disabled = true;

    try {
        const credential = EmailAuthProvider.credential(loggedInUser.email, senhaAtual);
        await reauthenticateWithCredential(loggedInUser, credential);
        await updatePassword(loggedInUser, novaSenha);
        showNotification("Sua senha de login foi alterada com sucesso!", "success");
        fecharModalAlterarSenha();
        fazerLogout();
    } catch (error) {
        console.error("Erro ao alterar senha:", error);
        if (error.code === 'auth/wrong-password') {
            showNotification("Senha atual incorreta.", "error");
        } else if (error.code === 'auth/requires-recent-login') {
            showNotification("Por seguran√ßa, fa√ßa login novamente e tente a altera√ß√£o.", "error");
        } else {
            showNotification("Erro ao alterar senha. Verifique os dados.", "error");
        }
    } finally {
        btn.innerText = "Confirmar Altera√ß√£o";
        btn.disabled = false;
    }
  };

   /* ================= HIST√ìRICO DE A√á√ïES ================= */
  window.abrirHistorico = function() {
      if (!loggedInUser) {
          showNotification("Voc√™ precisa estar logado para acessar o Hist√≥rico.", "error");
          return;
      }
      $("historicoModalOverlay").style.display = "block";
      $("historicoPasswordModal").style.display = "block";
      $("historicoSenhaInput").value = "";
      $("historicoSenhaInput").focus();
  };

  window.fecharHistoricoPasswordModal = function() {
      $("historicoModalOverlay").style.display = "none";
      $("historicoPasswordModal").style.display = "none";
  };

  window.fecharHistoricoModal = function() {
      $("historicoModalOverlay").style.display = "none";
      $("historicoModal").style.display = "none";
  };

  window.verificarSenhaHistorico = async function() {
      const senha = $("historicoSenhaInput").value.trim();
      if (senha !== HISTORY_SECRET_CODE) {
          showNotification('C√≥digo secreto incorreto.', 'error');
          return;
      }
      fecharHistoricoPasswordModal();
      $("historicoModal").style.display = "block";

      // Reseta a pagina√ß√£o e filtros ao abrir o modal
      lastVisibleHistoryDoc = null; 
      hasMoreHistory = true; 
      historyData = []; 

      // Limpa os filtros
      $("historySearchInput").value = "";
      $("historyTipoSelect").value = "";
      $("historyUserSelect").innerHTML = '<option value="">-- todos --</option>'; // Limpa e adiciona o padr√£o
      $("historyDateStart").value = "";
      $("historyDateEnd").value = "";

      // Chamada para a nova fun√ß√£o de fetch em lote (carga inicial)
      await fetchHistoryBatch(true);
  };

  // Fun√ß√£o para registrar a√ß√£o no Firestore, recebe o tipo, o documento completo e DADOS ANTIGOS (se for edi√ß√£o)
  async function registrarAcao(tipo, dados, dadosAntigos = null) {
      if (!loggedInUser) return;
      try {
          const acao = {
              tipo: tipo, // CADASTRO, EDICAO, EXCLUSAO
              dados_completos: dados,
              dados_antigos: dadosAntigos, // NOVO: Para compara√ß√£o na edi√ß√£o
              veiculo_marca: dados.marca,
              veiculo_modelo: dados.modelo,
              veiculo_ano: dados.ano,
              usuario: loggedInUser.email,
              data: new Date().toISOString()
          };
          await addDoc(historicoAcoesCollection, acao);
      } catch (e) {
          console.error("Erro ao registrar a√ß√£o no hist√≥rico: ", e);
      }
  }

  window.toggleHistoryDetails = function(id) {
      const detailsDiv = document.getElementById('details-' + id);
      if (detailsDiv.style.display === 'none') {
          detailsDiv.style.display = 'block';
      } else {
          detailsDiv.style.display = 'none';
      }
  };

  // Helper para formatar os detalhes de instala√ß√£o (blocos)
  function renderInstalacoes(instalacoes, isNew, oldInstalacoes = []) {
      if (!instalacoes || instalacoes.length === 0) return '<div>Nenhuma instala√ß√£o cadastrada.</div>';

      let html = '';
      instalacoes.forEach((inst, idx) => {
          let changeFlag = '';
          if (isNew) {
              const oldInst = oldInstalacoes.find(o => o.nomeLocal === inst.nomeLocal) || {};
              // Verifica se alguma propriedade chave mudou
              if (inst.positivo !== oldInst.positivo ||
                  inst.negativo !== oldInst.negativo ||
                  inst.posChave !== oldInst.posChave ||
                  inst.bloqueio !== oldInst.bloqueio ||
                  inst.localDetalhe !== oldInst.localDetalhe ||
                  inst.saida2 !== oldInst.saida2 ||
                  inst.entrada2 !== oldInst.entrada2) {
                  changeFlag = ' <span style="color:#c52438; font-weight:700;">(EDITADO)</span>';
              }
          }
          
          // Adicionado verifica√ß√µes de exist√™ncia (|| '-') para as propriedades de inst
          const isRastreador = inst.tipo === 'rastreador' || currentVehicleResult?.tipo === 'rastreador';
          const posChaveLabel = isRastreador ? 'Saida 1' : 'P√≥s-chave';
          const bloqueioLabel = isRastreador ? 'Entrada 1/Bloqueio' : 'Bloqueio';
          const wireInfoAux = isRastreador ? `<span style="display:block;">Saida 2: ${inst.saida2 || '-'} | Entrada 2: ${inst.entrada2 || '-'}</span>` : '';

          html += `
              <div class="history-install-item">
                  <strong>Local: ${inst.nomeLocal || '-'} ${changeFlag}</strong> 
                  ${inst.localDetalhe ? `<span>Detalhe: ${inst.localDetalhe}</span>` : ''}
                  <span>Positivo: ${inst.positivo || '-'} | Negativo: ${inst.negativo || '-'}</span>
                  <span>${posChaveLabel}: ${inst.posChave || '-'} | ${bloqueioLabel}: ${inst.bloqueio || '-'}</span>
                  ${wireInfoAux}
              </div>
          `;
      });
      return html;
  }


  // Helper para renderizar a compara√ß√£o de dados em uma EDI√á√ÉO (EDICAO)
  function renderComparisonDetails(antigo, novo) {
      const fields = ['tipo', 'marca', 'modelo', 'submodelo', 'ano'];
      // Certifica-se que novo tem um valor ou √© um objeto vazio para seguran√ßa
      const dadosNovo = novo || {};
      const dadosAntigo = antigo || {};
      const isRastreador = dadosNovo.tipo === 'rastreador';
      const labelSubmodelo = isRastreador ? "Modelo Rastreador" : "Submodelo";
      
      const getVal = (data, field) => {
          // Se for Rastreador, o "submodelo" √© o nomeLocal da primeira instala√ß√£o
          if (field === 'submodelo' && isRastreador) {
              return data.instalacoes?.[0]?.nomeLocal || '-';
          }
          if (field === 'ano') {
             // Tratamento para ano e anoFinal com valores seguros
             const anoStart = data.ano || '-';
             const anoEnd = data.anoFinal;

             if (anoStart === '-') return '-';
             
             return anoEnd ? `${anoStart} a ${anoEnd}` : `${anoStart}`;
          }
          return data[field] || '-';
      };

      let htmlAntigo = '<h4><span style="color:var(--danger)">Antes</span> da Edi√ß√£o</h4>';
      let htmlNovo = '<h4><span style="color:var(--success)">Depois</span> da Edi√ß√£o</h4>';

      // Compara√ß√£o dos campos b√°sicos
      fields.forEach(field => {
          // Pula o campo Submodelo para Rastreador, pois ele n√£o existe no cadastro.
          if (isRastreador && field === 'submodelo') return;

          const label = field.charAt(0).toUpperCase() + field.slice(1);
          const valAntigo = getVal(dadosAntigo, field);
          const valNovo = getVal(dadosNovo, field);
          
          const changed = valAntigo !== valNovo;
          const spanAntigo = changed ? `<span class="changed-field">${valAntigo}</span>` : valAntigo;
          const spanNovo = changed ? `<span class="changed-field">${valNovo}</span>` : valNovo;

          htmlAntigo += `<p><b>${label}:</b> ${spanAntigo}</p>`;
          htmlNovo += `<p><b>${label}:</b> ${spanNovo}</p>`;
      });

      // Compara√ß√£o das Instala√ß√µes (Aqui √© mais complexo, apenas listamos os blocos)
      htmlAntigo += `<div style='margin-top:10px;'><b>Instala√ß√µes (${dadosAntigo.instalacoes?.length || 0}):</b></div>`;
      htmlAntigo += renderInstalacoes(dadosAntigo.instalacoes); 
      
      // Passa as instala√ß√µes antigas para a fun√ß√£o renderInstalacoes do NOVO para marcar o que mudou
      htmlNovo += `<div style='margin-top:10px;'><b>Instala√ß√µes (${dadosNovo.instalacoes?.length || 0}):</b></div>`;
      htmlNovo += renderInstalacoes(dadosNovo.instalacoes, true, dadosAntigo.instalacoes); 

      return `<div class="comparison-container"><div class="comparison-box">${htmlAntigo}</div><div class="comparison-box">${htmlNovo}</div></div>`;
  }

  // Helper para renderizar os detalhes completos de um item do hist√≥rico (EXCLUSAO / CADASTRO)
  function renderFullDetails(acao) {
      if (acao.dados_completos) {
          const dados = acao.dados_completos; // Vari√°vel local para acesso seguro
          const isRastreador = dados.tipo === 'rastreador';
          let html = '';
          html += `<p><b>ID do Documento:</b> ${dados.id || '-'}</p>`;
          html += `<p><b>Tipo:</b> ${dados.tipo || '-'}</p>`;
          html += `<p><b>Marca:</b> ${dados.marca || '-'}</p>`;
          html += `<p><b>Modelo:</b> ${dados.modelo || '-'}</p>`;
          
          if (!isRastreador) { // Pula submodelo se for rastreador
              html += `<p><b>Submodelo:</b> ${dados.submodelo || '-'}</p>`;
          }

          // Uso de verifica√ß√£o mais robusta para `anoFinal` e `ano`
          const anoStr = (dados.anoFinal && dados.ano) ? `${dados.ano} a ${dados.anoFinal}` : dados.ano || '-';
          html += `<p><b>Ano:</b> ${anoStr}</p>`;

          html += `<div style='margin-top:10px;'><b>Instala√ß√µes (${dados.instalacoes?.length || 0}):</b></div>`;
          html += renderInstalacoes(dados.instalacoes);

          return html;
      }
      return 'Detalhes indispon√≠veis.';
  }
  
  // Fun√ß√£o de fetch paginada do hist√≥rico
  window.fetchHistoryBatch = async function(isInitialLoad) {
      if (isLoadingHistory || (!hasMoreHistory && !isInitialLoad)) return;

      const btn = $("btnCarregarMaisHistorico");
      const listaDiv = $("historicoLista");
      const historyEndMessage = $("historyEndMessage");
      
      isLoadingHistory = true;
      historyEndMessage.style.display = "none";
      btn.innerText = isInitialLoad ? "Carregando..." : "Carregando mais...";
      btn.disabled = true;
      // Garante que o bot√£o esteja vis√≠vel durante o carregamento inicial
      if (isInitialLoad) btn.style.display = "block"; 

      if(isInitialLoad) {
          historyData = [];
          listaDiv.innerHTML = '<p style="text-align:center; color:var(--muted)">Carregando hist√≥rico...</p>';
      }


      try {
          let q;
          if (!isInitialLoad && lastVisibleHistoryDoc) {
              // Se houver um √∫ltimo documento vis√≠vel, busca a pr√≥xima p√°gina
              q = query(historicoAcoesCollection, orderBy("data", "desc"), startAfter(lastVisibleHistoryDoc), limit(HISTORY_BATCH_SIZE));
          } else {
              // Primeira busca
              q = query(historicoAcoesCollection, orderBy("data", "desc"), limit(HISTORY_BATCH_SIZE));
          }

          const querySnapshot = await getDocs(q);
          const newDocs = [];
          let lastDoc = null;
          
          querySnapshot.forEach((doc) => {
              newDocs.push({ id: doc.id, ...doc.data() });
              lastDoc = doc;
          });

          if (lastDoc) {
              lastVisibleHistoryDoc = lastDoc;
          }

          if (newDocs.length < HISTORY_BATCH_SIZE) {
              hasMoreHistory = false;
          }

          // Adiciona os novos documentos √† lista global e renderiza
          historyData.push(...newDocs);
          renderHistoricoLista(historyData); 
          
          // Popula o filtro de usu√°rios (apenas na carga inicial)
          if(isInitialLoad) {
              const users = Array.from(new Set(historyData.map(a => a.usuario))).sort();
              users.forEach(u => addOpt("historyUserSelect", u));
          }

      } catch (e) {
          console.error("Erro ao carregar hist√≥rico: ", e);
          hasMoreHistory = false;
          showNotification("Erro ao carregar hist√≥rico de a√ß√µes.", "error");
          if(isInitialLoad) {
              $("historicoLista").innerHTML = '<p style="text-align:center; color:var(--danger)">Erro ao carregar hist√≥rico.</p>';
          }
      } finally {
          isLoadingHistory = false;
          btn.innerText = "Carregar Mais 50 Registros Antigos";
          btn.disabled = false;
          // Esconde o bot√£o se n√£o houver mais
          if (!hasMoreHistory) {
              btn.style.display = "none";
              historyEndMessage.style.display = "block";
          } else if (historyData.length === 0) {
              // Caso n√£o tenha nenhum dado
              btn.style.display = "none";
              $("historicoLista").innerHTML = '<p style="text-align:center; color:var(--muted)">Nenhum registro encontrado.</p>';
          } else {
             btn.style.display = "block";
          }
      }
  };


  function renderHistoricoLista(lista) {
      const listaDiv = $("historicoLista");
      listaDiv.innerHTML = "";
      
      // Aplica os filtros locais
      const termo = $("historySearchInput").value.toLowerCase().trim();
      const tipo = $("historyTipoSelect").value;
      const usuario = $("historyUserSelect").value;
      const dataInicio = $("historyDateStart").value;
      const dataFim = $("historyDateEnd").value;

      let dataInicioMs = 0;
      let dataFimMs = Infinity;

      if (dataInicio) {
          const [year, month, day] = dataInicio.split('-');
          dataInicioMs = new Date(year, month - 1, day).getTime();
      }
      if (dataFim) {
          const [year, month, day] = dataFim.split('-');
          const dataFimObj = new Date(year, month - 1, day);
          dataFimMs = dataFimObj.getTime() + (24 * 60 * 60 * 1000) - 1;
      }


      const listaFiltrada = lista.filter(acao => {
          // CORRE√á√ÉO: Acesso seguro a dados_completos para prevenir falhas no filtro
          const dados = acao.dados_completos || {}; 
          // Uso de || '' para todas as propriedades acessadas na string de busca
          const fullString = `${dados.tipo || ''} ${dados.marca || ''} ${dados.modelo || ''} ${dados.submodelo || ''} ${dados.ano || ''} ${acao.usuario || ''} ${acao.tipo || ''}`.toLowerCase();
          
          const matchTexto = termo.split(" ").every(t => fullString.includes(t));
          const matchTipo = !tipo || acao.tipo === tipo;
          const matchUsuario = !usuario || acao.usuario === usuario;

          // Filtro por data
          const dataAcao = new Date(acao.data).getTime();
          const matchData = dataAcao >= dataInicioMs && dataAcao <= dataFimMs;

          return matchTexto && matchTipo && matchUsuario && matchData;
      });


      if (listaFiltrada.length === 0) {
          listaDiv.innerHTML = '<p style="text-align:center; color:var(--muted)">Nenhum registro encontrado com os filtros aplicados.</p>';
          return;
      }

      listaFiltrada.forEach(acao => {
          // CORRE√á√ÉO: Acesso seguro a dados_completos para prevenir falhas na renderiza√ß√£o
          const dados = acao.dados_completos || {}; 
          
          const dataFormatada = new Date(acao.data).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' });
          const isEdicao = acao.tipo === 'EDICAO';
          const tituloTipo = isEdicao ? 'Edi√ß√£o de Dados' : acao.tipo === 'CADASTRO' ? 'Novo Cadastro' : 'Exclus√£o de Cadastro';
          const cor = isEdicao ? '#0ea5a3' : acao.tipo === 'CADASTRO' ? '#10b981' : '#ef4444';
          const icone = isEdicao ? '‚úèÔ∏è' : acao.tipo === 'CADASTRO' ? '‚ûï' : 'üóëÔ∏è';
          
          const infoAno = (dados.anoFinal && dados.ano) ? `(${dados.ano} a ${dados.anoFinal})` : (dados.ano ? `(${dados.ano})` : '');
          const infoSub = dados.tipo !== 'rastreador' && dados.submodelo ? ` ${dados.submodelo}` : '';

          const target = dados.tipo === 'rastreador' ? 
              `${dados.marca || ''} ${dados.modelo || ''}` :
              `${dados.marca || ''} ${dados.modelo || ''} ${infoAno}${infoSub}`;

          const html = `
              <div class="wire-item" style="border-bottom: 1px solid #e6eef7; padding: 12px 0;">
                  <div class="wire-label" style="flex-direction: column; align-items: flex-start;">
                      <div style="font-size: 14px; font-weight: 700; color: ${cor}; margin-bottom: 4px;">${icone} ${tituloTipo}</div>
                      <span style="font-size: 15px; color: #0f172a; font-weight: 600;">Ve√≠culo/Rastreador: ${target || 'Dados Indispon√≠veis'}</span>
                      <span class="small" style="margin-top: 4px;">Por: <strong>${acao.usuario || '-'}</strong> em ${dataFormatada}</span>
                  </div>
                  <div>
                      <button class="btn btn-sec" style="font-size:13px; padding: 8px 12px;" onclick="toggleHistoryDetails('${acao.id}')">Ver Detalhes</button>
                  </div>
              </div>
              <div id="details-${acao.id}" class="history-details" style="display:none;">
                  ${isEdicao ? renderComparisonDetails(acao.dados_antigos, dados) : renderFullDetails(acao)}
                  <p class="small" style="text-align:right; margin-top: 10px;">ID do Registro de A√ß√£o: ${acao.id}</p>
              </div>
          `;
          listaDiv.innerHTML += html;
      });
  }

  // Aplica os filtros locais
  window.filtrarHistorico = function() {
      // Como o filtro √© local, basta renderizar novamente a lista com os dados j√° carregados (historyData)
      renderHistoricoLista(historyData);
  };

  /* ================= CARREGAMENTO INICIAL ================= */
  async function carregarDadosDoFirebase() {
    $("resultado").innerText = "Carregando banco de dados...";
    try {
      const querySnapshot = await getDocs(veiculosCollection);
      userDB = [];
      querySnapshot.forEach((doc) => {
        userDB.push({ id: doc.id, ...doc.data() });
      });
      db = [...userDB]; // C√≥pia dos dados para a busca principal
      
      $("resultado").innerText = "Sistema pronto. Fa√ßa sua busca.";
      
      if($("editarAba").style.display === "block") {
          // Inicializa os filtros se a aba estiver aberta
          popularMarcasEdit();
          popularModelosEdit();
          popularSubsEdit();
          popularAnosEdit();
          renderLista();
      }

    } catch (e) {
      console.error("Erro ao ler dados: ", e);
      $("resultado").innerText = "Erro ao conectar com servidor.";
      showNotification("Erro de conex√£o com o servidor", "error");
    }
  }

  /* ================= AUTH STATE LISTENER ================= */
  onAuthStateChanged(auth, (user) => {
    loggedInUser = user;
    updateUIAuth(user);
    carregarDadosDoFirebase();
  });


  /* ================= UI FUNCTIONS ================= */

  window.abrirCadastro = function() {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para cadastrar ve√≠culos.", "error");
        return;
    }
    editarIndex = null;
    oldVehicleData = null; // Zera o dado antigo
    tempInstalacoes = [];
    renderTempInstalacoes();
    limparCamposInstalacao();
    $("modalTitle").innerText = "Cadastrar novo ve√≠culo/rastreador";
    $("addTipo").value = 'carro';
    handleTipoChange(); // Para popular a marca do tipo 'carro' e ajustar a UI
    ["addMarca", "addModelo", "addSubmodelo", "addAno", "addAnoFinal"].forEach(id => $(id).value = '');
    $("overlay").style.display = "block";
    $("modal").style.display = "block";
  };

  window.fecharModal = function() {
    $("overlay").style.display = "none";
    $("modal").style.display = "none";
    editarIndex = null;
    oldVehicleData = null;
    tempInstalacoes = [];
  };
  
  window.abrirEditar = function() {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para acessar a edi√ß√£o.", "error");
        return;
    }
    $("editarAba").style.display = "block";
    $("gridPrincipal").style.display = "none";
    
    // CORRE√á√ÉO: Chama as fun√ß√µes individuais para inicializar os filtros corretamente
    popularMarcasEdit();
    popularModelosEdit();
    popularSubsEdit();
    popularAnosEdit();
    
    renderLista(); 
  };

  window.voltarBusca = function() {
    $("editarAba").style.display = "none";
    $("gridPrincipal").style.display = "grid";
    // Garante que os selects de busca estejam limpos
    resetBusca();
  };

  function renderTempInstalacoes() {
    const lista = $("listaInstalacoesAdd");
    $("countInstalacoes").innerText = tempInstalacoes.length;
    if (tempInstalacoes.length === 0) {
      lista.innerHTML = '<div style="text-align:center; color:var(--muted); font-size:13px;">Nenhuma op√ß√£o adicionada ainda.</div>';
      return;
    }

    lista.innerHTML = tempInstalacoes.map((inst, index) => {
      // Determina se deve usar a formata√ß√£o de rastreador (se tiver dados auxiliares)
      const isTrackerFormat = inst.saida2 || inst.entrada2;

      const title = inst.nomeLocal || (isTrackerFormat ? `Rastreador: ${$("addMarca").value} ${$("addModelo").value}` : 'Local n√£o Nomeado');
      
      const posChaveLabel = isTrackerFormat ? 'P√≥s-chave (E1)' : 'P√≥s-chave';
      const bloqueioLabel = isTrackerFormat ? 'Bloqueio (S1)' : 'Bloqueio';

      const wireInfoAux = isTrackerFormat ? 
        `<span style="display:block;">Saida 2: ${inst.saida2 || '-'} | Entrada 2: ${inst.entrada2 || '-'}</span>` : 
        '';

      return `
        <div class="install-item">
          <div>
            <strong>${title}</strong>
            <span>Positivo: ${inst.positivo || '-'} | Negativo: ${inst.negativo || '-'}</span>
            <span style="display:block;">${posChaveLabel}: ${inst.posChave || '-'} | ${bloqueioLabel}: ${inst.bloqueio || '-'}</span>
            ${wireInfoAux}
            ${inst.localDetalhe ? `<span style="font-style:italic;">Detalhe: ${inst.localDetalhe}</span>` : ''}
          </div>
          <div style="display:flex; gap: 8px;">
            <button class="btn btn-sec" style="font-size:12px; padding: 6px 10px;" onclick="editarInstalacaoTemp(${index})">Editar</button>
            <button class="btn btn-danger" style="font-size:12px; padding: 6px 10px;" onclick="removerInstalacaoTemp(${index})">X</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function limparCamposInstalacao() {
    ["addNomeLocal", "addLocalDetalhe", "addPositivo", "addNegativo", "addPosChave", "addBloqueio", "addSaida2", "addEntrada2"].forEach(id => $(id).value = '');
    // Remove a flag de edi√ß√£o
    document.querySelector('#section2Title').innerText = '2. Adicionar Op√ß√£o de Instala√ß√£o';
    document.querySelector('#section2Title').classList.remove('changed-field');
  }

  window.adicionarInstalacaoNaLista = function() {
    const isRastreador = $("addTipo").value === 'rastreador';
    
    // Valida√ß√£o para Rastreador: exige marca e modelo preenchidos na se√ß√£o 1
    let nome = isRastreador ? `${$("addMarca").value} ${$("addModelo").value}`.trim() : $("addNomeLocal").value.trim();
    if(!nome || isRastreador && !$("addModelo").value.trim()) {
        showNotification(isRastreador ? "Preencha o Modelo do rastreador (Se√ß√£o 1)." : "D√™ um nome para o local (ex: Painel).", "error");
        return;
    }
    
    const novaInstalacao = {
      nomeLocal: nome,
      localDetalhe: isRastreador ? '' : $("addLocalDetalhe").value.trim(),
      positivo: $("addPositivo").value.trim(),
      negativo: $("addNegativo").value.trim(),
      posChave: $("addPosChave").value.trim(), // P√≥s-chave / Entrada 1
      bloqueio: $("addBloqueio").value.trim(), // Bloqueio / Saida 1
      saida2: $("addSaida2").value.trim(),     // Saida 2
      entrada2: $("addEntrada2").value.trim()   // Entrada 2
    };

    // Verifica se est√° editando uma instala√ß√£o existente
    const editIndex = parseInt($("addNomeLocal").dataset.editIndex);
    if (!isNaN(editIndex)) {
        tempInstalacoes[editIndex] = novaInstalacao;
        delete $("addNomeLocal").dataset.editIndex;
        showNotification("Op√ß√£o de instala√ß√£o atualizada!", "success");
    } else {
        tempInstalacoes.push(novaInstalacao);
        showNotification("Op√ß√£o de instala√ß√£o adicionada!", "success");
    }
    
    renderTempInstalacoes();
    limparCamposInstalacao();
    
    // Ap√≥s adicionar/editar, volta o foco para o nome do local
    if (!isRastreador) {
        $("addNomeLocal").focus();
    } else {
        $("addPositivo").focus();
    }
  };

  window.removerInstalacaoTemp = function(index) {
    tempInstalacoes.splice(index, 1);
    renderTempInstalacoes();
    limparCamposInstalacao();
    showNotification("Op√ß√£o de instala√ß√£o removida.", "info");
  };

  window.editarInstalacaoTemp = function(index) {
    const item = tempInstalacoes[index];
    
    // Prepara o formul√°rio para edi√ß√£o
    $("addNomeLocal").dataset.editIndex = index;
    const isRastreador = $("addTipo").value === 'rastreador';
    
    // Adaptar para rastreador se for o caso
    if (isRastreador) {
        // No modo rastreador, o nomeLocal vem do Modelo+Marca, mas n√£o √© edit√°vel na se√ß√£o de cabos
        $("addNomeLocal").value = '';
        $("addLocalDetalhe").value = '';
        $("addNomeLocal").disabled = true; // Desabilita para refor√ßar que n√£o √© para editar aqui
    } else {
        $("addNomeLocal").value = item.nomeLocal || '';
        $("addLocalDetalhe").value = item.localDetalhe || '';
        $("addNomeLocal").disabled = false;
    }

    $("addPositivo").value = item.positivo || '';
    $("addNegativo").value = item.negativo || '';
    $("addPosChave").value = item.posChave || '';
    $("addBloqueio").value = item.bloqueio || '';

    // Adiciona os novos campos auxiliares
    $("addSaida2").value = item.saida2 || '';
    $("addEntrada2").value = item.entrada2 || '';
    
    // Indica que est√° editando
    document.querySelector('#section2Title').innerText = '2. EDITANDO Op√ß√£o de Instala√ß√£o';
    document.querySelector('#section2Title').classList.add('changed-field');
    
    // Scrolla para o formul√°rio de instala√ß√£o
    $("modal").scrollTop = $("section2Title").offsetTop - 20; 
  };


  window.salvarVeiculo = async function() {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para SALVAR/EDITAR dados.", "error");
        fecharModal();
        return;
    }

    $("btnSalvar").innerText = "Salvando...";
    $("btnSalvar").disabled = true;

    if(tempInstalacoes.length === 0) {
        showNotification("Adicione pelo menos uma op√ß√£o de instala√ß√£o.", "error");
        $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
        $("btnSalvar").disabled = false;
        return;
    }

    const isRastreador = $("addTipo").value === 'rastreador';
    const submodeloValue = isRastreador ? "" : $("addSubmodelo").value.trim();
    const anoInicial = $("addAno").value.trim();
    const anoFinal = $("addAnoFinal").value.trim();
    
    // Valida√ß√£o b√°sica do ano
    if (anoFinal && parseInt(anoFinal) < parseInt(anoInicial)) {
         showNotification("O Ano Final n√£o pode ser menor que o Ano Inicial.", "error");
         $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
         $("btnSalvar").disabled = false;
         return;
    }
    
    const v = {
      tipo: $("addTipo").value,
      marca: $("addMarca").value,
      modelo: $("addModelo").value.trim(),
      submodelo: submodeloValue,
      ano: anoInicial,
      anoFinal: anoFinal, // Novo campo
      instalacoes: tempInstalacoes
    };

    if(!v.tipo || !v.marca || !v.modelo || !v.ano) {
        showNotification("Preencha Tipo, Marca, Modelo e Ano.", "error");
        $("btnSalvar").innerText = "Salvar Ve√≠culo Completo";
        $("btnSalvar").disabled = false;
        return;
    }

    try {
      if (editarIndex) {
        await updateDoc(doc(dbFirestore, "veiculos", editarIndex), v);
        // NOVO: Passa o oldVehicleData para o hist√≥rico
        await registrarAcao("EDICAO", { id: editarIndex, ...v }, oldVehicleData);
        showNotification("Dados atualizados!", "success");
      } else {
        const docRef = await addDoc(veiculosCollection, v);
        await registrarAcao("CADASTRO", { id: docRef.id, ...v });
        showNotification("Dados cadastrados!", "success");
      }
      
      await carregarDadosDoFirebase();
      fecharModal();

    } catch (e) {
      console.error("Erro ao salvar: ", e);
      showNotification("Erro ao salvar no servidor.", "error");
    } finally {
      $("btnSalvar").innerText = "Salvar Ve√≠culo ou Rastreador Completo";
      $("btnSalvar").disabled = false;
      oldVehicleData = null; // Limpa o dado antigo ap√≥s salvar
    }
  };


  /* ================= FUN√á√ïES AUXILIARES DE OP√á√ïES/SELECT ================= */

  function addOpt(id,v){
    let o = document.createElement("option");
    o.value = v;
    o.text = v;
    $(id).appendChild(o);
  }

  function clearOptions(id, placeholder){
    const el = $(id);
    if(!el) return;
    el.innerHTML = "";
    let o = document.createElement('option');
    o.value = "";
    o.text = placeholder || "-- selecione --";
    el.appendChild(o);
  }

  // FIX: L√≥gica ajustada para separar a visibilidade dos campos do modal da busca principal
  function handleTipoChange() {
    resetCascata(["marca","modelo","submodelo","ano"]);
    const tipo = $("tipoSelect").value || $("addTipo").value; // Usa o tipo do select que estiver ativo
    
    if (tipo) {
        const isRastreador = tipo === 'rastreador';
        const selectId = $("tipoSelect").value ? "marcaSelect" : "addMarca";
        
        // Popula a marca (comum a busca e modal)
        const marcasLista = marcas[tipo] || [];
        clearOptions(selectId);
        marcasLista.forEach(m => addOpt(selectId, m));

        // 1. L√≥gica para a ABA DE BUSCA PRINCIPAL
        if ($("tipoSelect").value) {
            $("marcaWrap").style.display = "block";
            $("subWrap").style.display = "none"; // Na busca, submodelo s√≥ aparece depois
            $("anoWrap").style.display = "none";
        } 
        
        // 2. L√≥gica para o MODAL (Cadastro/Edi√ß√£o) - Garante que os elementos existem antes de manipular
        if ($("addTipo")) {

const addModeloInput = $("addModelo");
            const addSubmodeloInput = $("addSubmodelo");
            
            // ============== IN√çCIO DA NOVA L√ìGICA DE PLACEHOLDERS ==============
            if (addModeloInput) {
                switch (tipo) {
                    case 'carro':
                        addModeloInput.placeholder = "Ex: Uno, Onix , Corola";
                        if(addSubmodeloInput) addSubmodeloInput.placeholder = "Ex: Way 1.3, Joy, LTZ, Cross";
                        break;
                    case 'moto':
                        addModeloInput.placeholder = "Ex: CG, Biz, Fazer";
                        if(addSubmodeloInput) addSubmodeloInput.placeholder = "Ex: Fan 125, 110i, 250 ABS";
                        break;
                    case 'caminhao':
                        addModeloInput.placeholder = "Ex: FH 460, Actros 2651";
                        if(addSubmodeloInput) addSubmodeloInput.placeholder = "Ex: Bitruck, 4x2, Toco";
                        break;
                    case 'rastreador':
                        addModeloInput.placeholder = "Ex: ST8210, NT40, KIT:12042 (Nome do Equipamento)";
                        if(addSubmodeloInput) addSubmodeloInput.placeholder = ""; // O campo fica invis√≠vel, mas por seguran√ßa
                        break;
                    default:
                        addModeloInput.placeholder = "";
                        if(addSubmodeloInput) addSubmodeloInput.placeholder = "";
                }
            }
            // ============== FIM DA NOVA L√ìGICA DE PLACEHOLDERS ==============

            // NOVO: Controle de layout do grid de submodelo/ano (section 1)
            const vehicleDetailsGrid = $("vehicleDetailsGrid");
            if (vehicleDetailsGrid) {
                if (isRastreador) {
                    $("addSubmodeloWrap").style.display = "none";
                    // Altera o layout para que a se√ß√£o de ano ocupe a largura total
                    vehicleDetailsGrid.style.gridTemplateColumns = "1fr"; 
                } else {
                    $("addSubmodeloWrap").style.display = "block";
                    // Volta o layout para duas colunas
                    vehicleDetailsGrid.style.gridTemplateColumns = "1fr 1fr"; 
                }
            }
            
            // NOVO: Controle dos campos de instala√ß√£o (Section 2)
            const auxConnectionsGrid = $("auxConnectionsGrid");
            const labelPosChave = $("labelPosChave");
            const labelBloqueio = $("labelBloqueio");
            
            $("localDetalheFields").style.display = isRastreador ? "none" : "block";

            if (isRastreador) {
                // ATUALIZA√á√ÉO DOS R√ìTULOS CONFORME PEDIDO
                labelPosChave.innerText = "P√≥s-chave (Entrada 1)";
                labelBloqueio.innerText = "Bloqueio (Saida 1)";
                
                auxConnectionsGrid.style.display = "grid";
                $("labelSaida2").innerText = "Saida 2";
                $("labelEntrada2").innerText = "Entrada 2";
            } else {
                labelPosChave.innerText = "P√≥s-chave";
                labelBloqueio.innerText = "Bloqueio";
                
                auxConnectionsGrid.style.display = "none";
                
                // Limpa os campos auxiliares ao mudar de Rastreador
                $("addSaida2").value = "";
                $("addEntrada2").value = "";
            }
        }

    } else {
        resetCascata(["marca","modelo","submodelo","ano"]);
        $("marcaWrap").style.display = "none";
    }
  }

  function resetCascata(steps){
    steps.forEach(s=>{
      if(s==='marca'){ clearOptions("marcaSelect","-- selecione --"); $("marcaWrap").style.display="none"; }
      if(s==='modelo'){ clearOptions("modeloSelect","-- selecione --"); $("modeloWrap").style.display="none"; }
      if(s==='submodelo'){ clearOptions("submodeloSelect","-- selecione --"); $("subWrap").style.display="none"; }
      if(s==='ano'){ clearOptions("anoSelect","-- selecione --"); $("anoWrap").style.display="none"; }
    });
  }
  
  // Adiciona o listener para o Tipo no Modal
  $("addTipo").addEventListener("change", handleTipoChange);


  /* ================= L√ìGICA DE FILTRO EM CASCATA - BUSCA PRINCIPAL ================= */

  $("tipoSelect").addEventListener("change", handleTipoChange);

  $("marcaSelect").addEventListener("change",()=>{
    const {tipoSelect,marcaSelect} = ids();
    resetCascata(["modelo","submodelo","ano"]);
    $("modeloWrap").style.display="block";
    
    const modelos = [...new Set(db.filter(v=>v.tipo===tipoSelect.value&&v.marca===marcaSelect.value).map(v=>v.modelo))];
    modelos.sort().forEach(m=>addOpt("modeloSelect",m));
  });

  $("modeloSelect").addEventListener("change",()=>{
    const {tipoSelect,marcaSelect,modeloSelect} = ids();
    resetCascata(["submodelo","ano"]);
    
    // Se for rastreador, n√£o tem submodelo, vai direto para o ano
    if (tipoSelect.value === 'rastreador') {
        $("subWrap").style.display="none";
        popularAnos(tipoSelect.value,marcaSelect.value,modeloSelect.value,"");
    } else {
        let subs=[...new Set(db.filter(v=>v.tipo===tipoSelect.value&&v.marca===marcaSelect.value&&v.modelo===modeloSelect.value).map(v=>v.submodelo).filter(s=>s))];
        
        if(subs.length){
            $("subWrap").style.display="block";
            clearOptions("submodeloSelect", "-- selecione --");
            subs.forEach(v=>addOpt("submodeloSelect",v));
        } else {
            $("subWrap").style.display="none";
            popularAnos(tipoSelect.value,marcaSelect.value,modeloSelect.value,"");
        }
    }
  });

  $("submodeloSelect").addEventListener("change",()=>{
    popularAnos($("tipoSelect").value,$("marcaSelect").value,$("modeloSelect").value,$("submodeloSelect").value);
  });

  // ATUALIZADO: L√≥gica para popular anos considerando o intervalo
  function popularAnos(t,m,mo,s){
    resetCascata(["ano"]);
    $("anoWrap").style.display="block";
    
    const filteredDb = db.filter(v => 
        v.tipo === t && 
        v.marca === m && 
        v.modelo === mo && 
        (t === 'rastreador' || !s || v.submodelo === s) 
    );
    
    let anosDisponiveis = new Set();
    
    filteredDb.forEach(v => {
        // Adiciona o ano inicial
        anosDisponiveis.add(parseInt(v.ano));
        // Se tiver anoFinal, adiciona todo o intervalo
        if(v.anoFinal) {
            for(let i = parseInt(v.ano) + 1; i <= parseInt(v.anoFinal); i++) {
                anosDisponiveis.add(i);
            }
        }
    });
    
    // Converte para array, ordena e popula o select
    Array.from(anosDisponiveis).sort((a,b) => a - b).forEach(a => addOpt("anoSelect", a));
  }


  /* ================= FILTROS LISTA DE EDI√á√ÉO - CORRIGIDO ================= */
  // OBS: Fun√ß√µes separadas para n√£o "resetar" o campo que o usu√°rio acabou de selecionar.

  function popularMarcasEdit() {
    const tipo = $("editTipo").value;
    const marcasLista = [...new Set(userDB.filter(v => !tipo || v.tipo === tipo).map(v => v.marca))];
    clearOptions("editMarca", "-- todos --");
    marcasLista.sort().forEach(m => addOpt("editMarca", m));
  }

  function popularModelosEdit() {
    const tipo = $("editTipo").value;
    const marca = $("editMarca").value;
    const modelosLista = [...new Set(userDB.filter(v => (!tipo || v.tipo === tipo) && (!marca || v.marca === marca)).map(v => v.modelo))];
    clearOptions("editModelo", "-- todos --");
    modelosLista.sort().forEach(m => addOpt("editModelo", m));
  }

  function popularSubsEdit() {
    const tipo = $("editTipo").value;
    
    // Oculta Submodelo se for Rastreador
    if(tipo === 'rastreador') {
         $("editSubWrap").style.display = 'none';
         return;
    }
    $("editSubWrap").style.display = 'block';

    const marca = $("editMarca").value;
    const modelo = $("editModelo").value;

    const submodelosLista = [...new Set(userDB.filter(v => 
        (!tipo || v.tipo === tipo) && 
        (!marca || v.marca === marca) && 
        (!modelo || v.modelo === modelo)
    ).map(v => v.submodelo).filter(s => s))];
    
    clearOptions("editSub", "-- todos --");
    submodelosLista.sort().forEach(s => addOpt("editSub", s));
  }

  function popularAnosEdit() {
    const tipo = $("editTipo").value;
    const marca = $("editMarca").value;
    const modelo = $("editModelo").value;
    const sub = $("editSub").value;
    
    const filteredDb = userDB.filter(v => 
        (!tipo || v.tipo === tipo) &&
        (!marca || v.marca === marca) &&
        (!modelo || v.modelo === modelo) &&
        (tipo === 'rastreador' || !sub || v.submodelo === sub)
    );

    let anosDisponiveis = new Set();
    
    filteredDb.forEach(v => {
        anosDisponiveis.add(parseInt(v.ano));
        if(v.anoFinal) {
            for(let i = parseInt(v.ano) + 1; i <= parseInt(v.anoFinal); i++) {
                anosDisponiveis.add(i);
            }
        }
    });

    const anosLista = Array.from(anosDisponiveis);
    clearOptions("editAno", "-- todos --");
    anosLista.sort((a,b) => a - b).forEach(a => addOpt("editAno", a));
  }

  // --- ATUALIZA√á√ÉO AQUI: BUSCA R√ÅPIDA COM INTERVALO DE ANOS ---
  window.filtrarEdicao = function() {
    const rawVal = $("editSearchInput").value.toLowerCase().trim();

    // 1. Detecta se existe um ano na busca (Ex: 2015)
    const yearMatch = rawVal.match(/\b(19|20)\d{2}\b/);
    const searchYear = yearMatch ? parseInt(yearMatch[0]) : null;

    // 2. Separa os termos de texto (remove o ano da busca textual)
    let textVal = rawVal;
    if(searchYear) textVal = textVal.replace(yearMatch[0], "").trim();
    const terms = textVal.split(" ").filter(t => t.length > 0);

    const tipo = $("editTipo").value;
    const marca = $("editMarca").value;
    const modelo = $("editModelo").value;
    const sub = $("editSub").value;
    const ano = $("editAno").value;

    const lista = userDB.filter(v => {
        // Verifica Intervalo de Anos (Se um ano foi digitado)
        if (searchYear) {
            const vInicio = parseInt(v.ano);
            const vFim = v.anoFinal ? parseInt(v.anoFinal) : vInicio;
            if (searchYear < vInicio || searchYear > vFim) return false;
        }

        // Verifica Texto nos campos principais
        const fullString = `${v.tipo} ${v.marca} ${v.modelo} ${v.submodelo || ''} ${v.instalacoes.map(i => `${i.nomeLocal} ${i.localDetalhe} ${i.positivo} ${i.negativo} ${i.posChave} ${i.bloqueio}`).join(' ')}`.toLowerCase();
        const matchTexto = terms.every(t => fullString.includes(t));
        
        // Filtros dos Selects
        const matchTipo = !tipo || v.tipo === tipo;
        const matchMarca = !marca || v.marca === marca;
        const matchModelo = !modelo || v.modelo === modelo;
        const matchSub = !sub || v.submodelo === sub;
        const matchAno = !ano || (v.ano === ano || (v.anoFinal && ano >= v.ano && ano <= v.anoFinal)); // Filtra se o ano est√° no range
        
        return matchTexto && matchTipo && matchMarca && matchModelo && matchSub && matchAno;
    });

    renderLista(lista);
  };

  // NOVOS LISTENERS (CORRIGIDO PARA N√ÉO RESETAR A PR√ìPRIA SELE√á√ÉO)
  $("editTipo").onchange = () => {
      clearOptions("editMarca"); clearOptions("editModelo"); clearOptions("editSub"); clearOptions("editAno");
      popularMarcasEdit();
      // O reset das op√ß√µes abaixo ser√° feito implicitamente pois seus valores ser√£o invalidados ou resetados pelos populates subsequentes
      popularModelosEdit();
      popularSubsEdit();
      popularAnosEdit();
      filtrarEdicao(); 
  };
  
  $("editMarca").onchange = () => {
      // N√ÉO limpa editMarca aqui, sen√£o perde a sele√ß√£o
      clearOptions("editModelo"); clearOptions("editSub"); clearOptions("editAno");
      popularModelosEdit();
      popularSubsEdit();
      popularAnosEdit();
      filtrarEdicao(); 
  };
  
  $("editModelo").onchange = () => { 
      // N√ÉO limpa editModelo aqui
      clearOptions("editSub"); clearOptions("editAno");
      popularSubsEdit();
      popularAnosEdit();
      filtrarEdicao(); 
  };
  
  $("editSub").onchange = () => { 
      popularAnosEdit(); 
      filtrarEdicao(); 
  }; 
  
  $("editAno").onchange = filtrarEdicao; 

  /* ================= LISTAGEM E RENDERIZA√á√ÉO ================= */
  
  function renderLista(lista=null){
    lista = lista || userDB;
    let c = $("listaVeiculos"); c.innerHTML = "";
    if(!lista.length){ c.innerHTML = "<i>Nenhum ve√≠culo encontrado</i>"; return; }
    
    const sortKey = $("editTipo").value === 'rastreador' ? 'marca' : 'modelo';
    lista.sort((a, b) => a[sortKey].localeCompare(b[sortKey]));
    
    lista.forEach((v) => {
      let d = document.createElement("div");
      d.style = "padding:10px 0;border-bottom:1px solid #ddd;";
      let qtdOpcoes = v.instalacoes ? v.instalacoes.length : 1;
      
      const submodeloInfo = v.tipo !== 'rastreador' && v.submodelo ? ` | ${v.submodelo}` : '';
      const anoDisplay = v.anoFinal ? `${v.ano} a ${v.anoFinal}` : v.ano;

      d.innerHTML = `
      <div style='display:flex;align-items:center;justify-content:space-between'>
        <div>
           <strong>${v.marca} ${v.modelo}</strong> (${anoDisplay})${submodeloInfo}<br>
           <span style="font-size:12px;color:#666">${qtdOpcoes} local(is) ${v.tipo === 'rastreador' ? 'de rastreador' : 'de ve√≠culo'}</span>
        </div>
        <div style="display:flex; gap: 8px;">
            <button class="btn btn-primary" style="padding:6px 12px; font-size:13px;" onclick="editarVeiculo('${v.id}')">Editar</button>
            <button class="btn btn-danger" style="padding:6px 12px; font-size:13px;" onclick="excluirVeiculo('${v.id}')">Excluir</button>
        </div>
      </div>
      `;
      c.appendChild(d);
    });
  }

  /* ================= BUSCA R√ÅPIDA E RESULTADO ================= */

  function ids(){
    return {
      tipoSelect: $("tipoSelect"),
      marcaSelect: $("marcaSelect"),
      modeloSelect: $("modeloSelect"),
      submodeloSelect: $("submodeloSelect"),
      anoSelect: $("anoSelect")
    };
  }
  
  // Autocomplete para busca r√°pida
  const mainInput = $("mainSearchInput");
  const suggestionsBox = $("mainSuggestions");

  // --- ATUALIZA√á√ÉO AQUI: BUSCA PRINCIPAL COM INTERVALO DE ANOS ---
  mainInput.addEventListener("input", function() {
      const rawVal = this.value.toLowerCase().trim();
      if(rawVal.length < 2) {
          suggestionsBox.style.display = "none";
          return;
      }
      
      // 1. Detecta ano na busca
      const yearMatch = rawVal.match(/\b(19|20)\d{2}\b/);
      const searchYear = yearMatch ? parseInt(yearMatch[0]) : null;

      // 2. Separa os termos de texto (remove o ano da busca textual)
      let textVal = rawVal;
      if(searchYear) textVal = textVal.replace(yearMatch[0], "").trim();
      const terms = textVal.split(" ").filter(t => t.length > 0);

      const matches = db.filter(v => {
          // Verifica Intervalo de Anos
          if (searchYear) {
              const vInicio = parseInt(v.ano);
              const vFim = v.anoFinal ? parseInt(v.anoFinal) : vInicio;
              if (searchYear < vInicio || searchYear > vFim) return false;
          }

          // Verifica Texto
          const anoStr = v.anoFinal ? `${v.ano} a ${v.anoFinal}` : v.ano;
          const str = `${v.tipo} ${v.marca} ${v.modelo} ${v.submodelo || ''} ${anoStr}`.toLowerCase();
          return terms.every(t => str.includes(t));
      }).slice(0, 8); // Limita a 8 sugest√µes

      if(matches.length === 0) {
          suggestionsBox.style.display = "none";
          return;
      }

      suggestionsBox.innerHTML = "";
      matches.forEach(v => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          const subInfo = v.submodelo && v.tipo !== 'rastreador' ? ` | ${v.submodelo}` : '';
          const anoDisplay = v.anoFinal ? `${v.ano} a ${v.anoFinal}` : v.ano;
          
          div.innerHTML = `<strong>${v.marca} ${v.modelo}</strong> <small>(${anoDisplay})${subInfo}</small>`;
          div.onclick = () => {
              // Se tiver ano buscado, preenche com ele, sen√£o usa o padr√£o
              const displayYear = searchYear ? searchYear : anoDisplay;
              mainInput.value = `${v.marca} ${v.modelo} ${displayYear}`;
              suggestionsBox.style.display = "none";
              exibirResultadoDireto(v);
          };
          suggestionsBox.appendChild(div);
      });
      suggestionsBox.style.display = "block";
  });

  document.addEventListener("click", (e) => {
      if(e.target !== mainInput) suggestionsBox.style.display = "none";
  });


  /* ================= BUSCA INTELIGENTE (ATUALIZADO) ================= */

  window.buscar = function() {
    let {tipoSelect,marcaSelect,modeloSelect,submodeloSelect,anoSelect} = ids();
    
    // ATUALIZADO: Filtra o DB considerando o intervalo de anos
    let resultados = db.filter(v => {
      const anoBusca = parseInt(anoSelect.value);
      const anoInicio = parseInt(v.ano);
      const anoFim = v.anoFinal ? parseInt(v.anoFinal) : anoInicio;
      
      const anoMatch = anoBusca >= anoInicio && anoBusca <= anoFim;

      return v.tipo === tipoSelect.value && 
             v.marca === marcaSelect.value && 
             v.modelo === modeloSelect.value && 
             (v.tipo === 'rastreador' || (v.submodelo||"") === submodeloSelect.value) && 
             anoMatch;
    });

    if(resultados.length === 0) {
      $("resultado").innerHTML = "Nenhum padr√£o encontrado para os filtros selecionados.";
      $("seletorLocalWrap").style.display = "none";
      $("btnEditarResultado").style.display = "none";
      currentVehicleResult = null;
      return;
    }

    // Como o filtro em cascata j√° deve retornar 1 resultado exato, pegamos o primeiro.
    const r = resultados[0]; 
    exibirResultadoDireto(r);
  };

  function exibirResultadoDireto(r) {
    currentVehicleResult = r;
    $("seletorLocalWrap").style.display = "none";
    
    // Mostra bot√£o de edi√ß√£o se o usu√°rio estiver logado e se for um item salvo no DB (tem id)
    if(loggedInUser && r.id) {
        $("btnEditarResultado").style.display = "block";
        $("btnEditarResultado").innerHTML = `<button class="btn btn-sec" onclick="editarVeiculo('${r.id}')">Editar Padr√£o</button>`;
    } else {
        $("btnEditarResultado").style.display = "none";
    }

    let instalacoes = r.instalacoes || [];

    // L√≥gica de fallback para manter compatibilidade com dados antigos que usam campos soltos
    if(instalacoes.length === 0 && r.local) {
        instalacoes.push({ 
            nomeLocal: "Padr√£o (√önico)", 
            localDetalhe: r.local, 
            positivo: r.positivo, 
            negativo: r.negativo, 
            posChave: r.posChave, 
            bloqueio: r.bloqueio 
        });
    }

    // Se houver mais de uma op√ß√£o, mostra o seletor
    if (instalacoes.length > 1) {
        $("seletorLocalWrap").style.display = "block";
        const select = $("resultadoLocalSelect");
        select.innerHTML = "";
        instalacoes.forEach((inst, index) => {
            let opt = document.createElement("option");
            opt.value = index;
            opt.text = `${inst.nomeLocal} ${inst.localDetalhe ? `(${inst.localDetalhe})` : ''}`;
            select.appendChild(opt);
        });
        
        // Exibe o resultado da primeira op√ß√£o por padr√£o
        renderResultadoFios(r, instalacoes[0]);
        
        // Adiciona o listener para mudan√ßa de local
        select.onchange = function() {
            renderResultadoFios(r, instalacoes[this.value]);
        };
        
        $("seletorLocalTitle").innerText = `Op√ß√£o de Local de Instala√ß√£o (${instalacoes.length} dispon√≠veis):`;
        
    } else if (instalacoes.length === 1) {
        // Se houver apenas uma op√ß√£o, exibe ela diretamente
        $("seletorLocalWrap").style.display = "none";
        renderResultadoFios(r, instalacoes[0]);
    } else {
        // Se n√£o houver instala√ß√µes
        $("resultado").innerHTML = `
            <div class="main-title-box">‚ö†Ô∏è Nenhuma informa√ß√£o de instala√ß√£o cadastrada para **${r.marca} ${r.modelo}**.</div>
            <p class="small" style="text-align:center;">Tente pesquisar por outro ve√≠culo ou contate o administrador.</p>
        `;
    }
  }

  function renderResultadoFios(veiculo, dados) {
    const isRastreador = veiculo.tipo === 'rastreador';
    let icon = isRastreador ? 'üì°':'>';
    let mainLabel = isRastreador ? 'Rastreador':'Ve√≠culo';
    const anoDisplay = veiculo.anoFinal ? `${veiculo.ano} a ${veiculo.anoFinal}` : veiculo.ano;
    let mainValue = `${veiculo.marca} ${veiculo.modelo} (${anoDisplay})${veiculo.submodelo && !isRastreador ? ` ${veiculo.submodelo}` : ''}`;
    
    // Adiciona o nome do local ao t√≠tulo se n√£o for rastreador (o nome do local √© o submodelo para rastreadores)
    if (!isRastreador && dados.nomeLocal) {
         mainValue += ` - ${dados.nomeLocal}`;
    }
    
    if(dados.localDetalhe) {
        mainValue += ` (${dados.localDetalhe})`;
    }

    // NOVOS R√ìTULOS
    const posChaveLabel = isRastreador ? "P√≥s-chave (Entrada 1)" : "P√≥s-chave";
    const bloqueioLabel = isRastreador ? "Bloqueio (Saida 1)" : "Bloqueio";
    
    let html = `<div class="main-title-box">${icon} ${mainLabel}: **${mainValue}**</div>`;

    const renderWireItem = (label, value, valueClass = "") => {
        if (!value) return '';
        const displayValue = value.length > 30 ? value.substring(0, 30) + '...' : value;
        return `
            <div class="wire-item">
                <span class="wire-label">${label}</span>
                <span class="wire-value ${valueClass}">${displayValue}</span>
            </div>
        `;
    };

    html += renderWireItem(' Positivo ', dados.positivo, 'positivo-val');
    html += renderWireItem(' Negativo ', dados.negativo, 'negativo-val');
    html += renderWireItem(` ${posChaveLabel} `, dados.posChave, 'poschave-val');
    html += renderWireItem(` ${bloqueioLabel}`, dados.bloqueio, bloqueioLabel.includes('Saida 1') ? 'bloqueio-val' : 'poschave-val'); // Use bloqueio-val se for Saida 1

    if (isRastreador) {
        html += '<div style="margin-top:10px; font-size:14px; font-weight:600; color:#0f766e; border-top: 1px solid #e2e8f0; padding-top: 10px;">Conex√µes Auxiliares (Opcional)</div>';
        html += renderWireItem(' Saida 2', dados.saida2);
        html += renderWireItem(' Entrada 2', dados.entrada2);
    }
    
    $("resultado").innerHTML = html;
  }

  window.resetBusca = function() {
    ["tipoSelect","marcaSelect","modeloSelect","submodeloSelect","anoSelect"].forEach(id => $(id).value = "");
    ["marcaWrap","modeloWrap","subWrap","anoWrap"].forEach(id => $(id).style.display = "none");
    $("seletorLocalWrap").style.display = "none";
    $("btnEditarResultado").style.display = "none";
    $("mainSearchInput").value = "";
    $("resultado").innerHTML = "Sistema pronto. Fa√ßa sua busca.";
  };


  /* ================= SALVAR, EXCLUIR E EDITAR ================= */

  window.editarVeiculo = function(id) {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para EDITAR dados.", "error");
        return;
    }
    const v = userDB.find(x => x.id === id);
    if(!v) {
        showNotification('Ve√≠culo n√£o encontrado.','error');
        return;
    }

    editarIndex = id;
    // NOVO: Armazena o estado anterior (deep copy para evitar modifica√ß√£o)
    oldVehicleData = JSON.parse(JSON.stringify(v));
    
    $("modalTitle").innerText = `Editar ve√≠culo ou rastreador: ${v.marca} ${v.modelo} (${v.ano})`;
    
    // 1. Popula dados b√°sicos
    $("addTipo").value = v.tipo;
    handleTipoChange(); // Para ajustar a UI (marcas, campos espec√≠ficos)
    
    const isRastreador = v.tipo === 'rastreador';
    
    // Popula as marcas (j√° populado por handleTipoChange, mas garante que o valor selecionado exista)
    clearOptions("addMarca");
    marcas[v.tipo].forEach(m => addOpt("addMarca", m));
    $("addMarca").value = v.marca;

    $("addModelo").value = v.modelo;
    $("addSubmodelo").value = v.submodelo;
    $("addAno").value = v.ano;
    $("addAnoFinal").value = v.anoFinal || ''; // Novo campo
    
    // 2. Popula instala√ß√µes tempor√°rias
    tempInstalacoes = v.instalacoes || [];
    
    // L√≥gica de fallback para dados antigos (converte para o novo formato de instala√ß√µes)
    if(tempInstalacoes.length === 0 && v.local) {
        tempInstalacoes.push({ 
            nomeLocal: "Padr√£o (√önico)", 
            localDetalhe: v.local, 
            positivo: v.positivo, 
            negativo: v.negativo, 
            posChave: v.posChave, 
            bloqueio: v.bloqueio 
        });
    }

    renderTempInstalacoes();
    limparCamposInstalacao();

    // 3. Abre o modal
    $("overlay").style.display = "block";
    $("modal").style.display = "block";
    
    // Se for rastreador, desabilita a edi√ß√£o dos campos que n√£o devem ser alterados
    if (isRastreador) {
        // No modo rastreador, Marca, Modelo e Tipo s√£o cruciais e n√£o devem ser alterados levianamente.
        $("addTipo").disabled = true;
        $("addMarca").disabled = true;
        $("addModelo").disabled = true;
    } else {
        $("addTipo").disabled = false;
        $("addMarca").disabled = false;
        $("addModelo").disabled = false;
    }

    // Se veio da aba de busca, volta para a aba de busca depois de fechar.
    if($("editarAba").style.display === "none") {
        $("modal").onclose = () => { fecharModal(); };
    } else {
        // Se veio da aba de edi√ß√£o, mant√©m a aba de edi√ß√£o (o modal fecha e a lista continua)
        $("modal").onclose = () => { fecharModal(); renderLista(); };
    }
  };


  window.excluirVeiculo = async function(id) {
    if (!loggedInUser) {
        showNotification("Voc√™ precisa estar logado para EXCLUIR dados.", "error");
        return;
    }
    if (!confirm("Tem certeza que deseja EXCLUIR este ve√≠culo/rastreador? Esta a√ß√£o √© irrevers√≠vel.")) {
        return;
    }

    const veiculoParaExcluir = userDB.find(v => v.id === id);
    if (!veiculoParaExcluir) {
        showNotification("Ve√≠culo n√£o encontrado.", "error");
        return;
    }

    try {
        await deleteDoc(doc(dbFirestore, "veiculos", id));
        
        // NOVO: Registra a exclus√£o no hist√≥rico
        await registrarAcao("EXCLUSAO", veiculoParaExcluir);

        showNotification("Ve√≠culo/Rastreador exclu√≠do com sucesso!", "success");
        await carregarDadosDoFirebase();
        filtrarEdicao(); // Atualiza a lista na aba de edi√ß√£o
        
    } catch (e) {
        console.error("Erro ao excluir: ", e);
        showNotification("Erro ao excluir no servidor.", "error");
    }
  };

</script>
</body>
</html>
